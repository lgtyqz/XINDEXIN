<!DOCTYPE html>
<html>
    <head>
        <title>XINDEXIN</title>
        <meta charset="utf-8">
        <meta name="description" content="A simple yet addictive arcade shooter that will keep you coming back.">
        <style>
            canvas {
                border: 1px solid black;
            }
            .img {
                visibility: hidden;
            }
            body {
                height: 100%;
                overflow: hidden;
            }
        </style>
        <script>
//headers

var GAME = {
    canvas: document.createElement("canvas"),
    start: function(){
        this.canvas.width = 1200;
        this.canvas.height = 600;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        //this.load();
    },
    activate: function(){
        this.interval = setInterval(main, 20);
        GAME.DATE = new Date();
        this.isPaused = false;
        console.log("Nuclear Cuke");
        if(player.position.x == 0 && player.position.y == 0 && player.hp == 3){
            alert("Weapon Loadout:\nZ: " +  player.weapons[0].name +
        "\nX: " + player.weapons[1].name +
        "\nC: " + player.weapons[2].name);
        }
        setSprites();
    },
    pause: function(){
        clearInterval(this.interval);
        this.isPaused = true;
        for(var i = 0; i < musics.length; i++){
            musics[i].pause();
        }
    },
    clear: function(){
        this.context.clearRect(0, 0, this.canvas.width * 2, this.canvas.height * 2);
    },
    save: function(){
        var gameData = {
            frameCount: GAME.frameCount,
            level: GAME.level,
            hp: player.hp,
            difficulty: GAME.difficulty
        };
        localStorage.Shooter = JSON.stringify(gameData);
    },
    load: function(){
        if(localStorage.Shooter){
            var gameData = JSON.parse(localStorage.Shooter);
            this.frameCount = gameData.frameCount;
            this.level = gameData.level;
            player.hp = gameData.hp;
            this.difficulty = gameData.difficulty;
        }else{
            this.frameCount = 0;
            this.level = 1;
            player.hp = 3;
            this.difficulty = 0;
            this.save();
        }
    },
    restart: function(){
        entities = [];
        backgroundTiles = [];
        backgroundTimer = 0;
        spawnedStart = false;
        player = new Player(30, GAME.canvas.height/2 - 15, 30, 30);
        rWeapons.sort( function() { return 0.5 - Math.random() } );
        player.weapons = [rWeapons[5], rWeapons[1], rWeapons[3]];
        GAME.load();
    },
    handleBGM: function(){
        for(var i = 0; i < musics.length; i++){
            musics[i].pause();
        }
        musics[GAME.level].play();
    },
    nextLevel: function(){
        GAME.level++;
        GAME.frameCount = 0;
        backgroundTimer = 0;
        player.hp = 3;
        GAME.handleBGM();
        sounds.bossDeath.play();
        GAME.save();
    },
    frameCount: 0,
    gravity: 1,
    friction: 0.9,
    level: 0,
    levelLengths: [9000, 10000, 10000, 12000],
    difficulty: 0,
    camera: {x:0, y:0},
    debugMode: false,
    isPaused: true,
    musicVolume: 1,
    DATE: new Date(),
    loadedEverything: false,
}
function colorToList(color){
    return [
        parseInt(color.slice(1, 3), 16),
        parseInt(color.slice(3, 5), 16),
        parseInt(color.slice(5, 7), 16)];
}
function listToColor(color){
    return "#" + ("0"+(Number(color[0]).toString(16))).slice(-2).toUpperCase() +
                ("0"+(Number(color[1]).toString(16))).slice(-2).toUpperCase() +
                ("0"+(Number(color[2]).toString(16))).slice(-2).toUpperCase();
}

var shifting = false;
var hasWalls = false; //don't ask, don't tell--level 4 thing

var sounds = {
    pew: new Audio("./sfx/pew.ogg"),
    laserPew: new Audio("./sfx/laserpew.ogg"),
    hit: new Audio("./sfx/hit.ogg"),
    hurt: new Audio("./sfx/hurt.ogg"),
    wind: new Audio("./sfx/wind.ogg"),
    boom: new Audio("./sfx/boom.ogg"),
    mehPew: new Audio("./sfx/mehpew.ogg"),
    weirdPew: new Audio("./sfx/weirdpew.ogg"),
    shieldStart: new Audio("./sfx/shieldstart.ogg"),
    shieldBlock: new Audio("./sfx/shieldhit.ogg"),
    rush: new Audio("./sfx/rush.ogg"),
    uwu: new Audio("./sfx/uwu.ogg"),
    bossDeath: new Audio("./sfx/bossdeath.ogg"),
    collect: new Audio("./sfx/winning.ogg"),
    pause: new Audio("./sfx/pause.ogg"),
    otherHurt: new Audio("./sfx/otherhurt.ogg"),
    beam: new Audio("./sfx/beam.ogg"),
    voop: new Audio("./sfx/voop.ogg"),
    wallBlock: new Audio("./sfx/wallreflect.ogg"),
    no: new Audio("./sfx/no.ogg"),
    bulletScreen: new Audio("./sfx/bulletscreen.ogg"),
    enter: new Audio("./sfx/enter.ogg"),
    bark: new Audio("./sfx/bark.ogg"),
    shieldBreak: new Audio("./sfx/shieldbreak.ogg"),
    gong: new Audio("./sfx/gong.ogg"),
    metalBark: new Audio("./sfx/metalbark.ogg"),
    birdScream: new Audio("./sfx/birdscream.ogg"), 
}
var musics = [
    new Audio("./music/Blank.ogg"), //Menu
	new Audio("./music/A_Melancholy_Autumn.ogg"), //Level 1 music
	new Audio("./music/Urban_Groove.ogg"), //Level 2 music
	new Audio("./music/Bath_of_Ice.ogg"), //Level 3 music
	new Audio("./music/Apocalypse_Lab.ogg"), //Level 4 music
];
var spriteAnimations = {};
function setSprites(){
    spriteAnimations = {
        player_idle: new Animation([
                    new Sprite("player", [1, 1]),
                    ],
                    1, false),
        lost_idle: new Animation([
                    new Sprite("lost", [1, 1]),
                    ],
                    1, false),
        lost_walk: new Animation([
                    new Sprite("lost", [1, 1]),
                    new Sprite("lost2", [1, 1]),
                    new Sprite("lost3", [1, 1]),
                    new Sprite("lost4", [1, 1]),
                    new Sprite("lost5", [1, 1]),
                    new Sprite("lost6", [1, 1]),
                    new Sprite("lost7", [1, 1]),
                    new Sprite("lost8", [1, 1]),
                    ],
                    10, true),
        cross_idle: new Animation([
                    new Sprite("cross", [1, 1]),
                    ],
                    1, false),
        cross_limp: new Animation([
                    new Sprite("cross", [1, 1]),
                    new Sprite("cross-tilt", [1, 1]),
                    ],
                    12, true),
        bat: new Animation([
                    new Sprite("bat", [1, 1]),
                    new Sprite("bat-fl-up", [1, 1]),
                    new Sprite("bat-fl-down", [1, 1]),
                    ],
                    7, true),
        raven_idle: new Animation([
                    new Sprite("raven", [1.5, 1.3]),
                    new Sprite("raven2", [1.5, 1.3]),
                    new Sprite("raven3", [1.5, 1.3]),
                    new Sprite("raven4", [1.5, 1.3]),
                    new Sprite("raven5", [1.5, 1.3]),
                    new Sprite("raven6", [1.5, 1.3]),
                    new Sprite("raven7", [1.5, 1.3]),
                    new Sprite("raven8", [1.5, 1.3]),
                    new Sprite("raven9", [1.5, 1.3]),
                    ],
                    5, true),
        raven_fly: new Animation([
                    new Sprite("raven", [1.5, 1.3]),
                    ],
                    1, false),
        mirage: new Animation([
                    new Sprite("mirage", [1, 1]),
                    ],
                    1, false),
        demonicShape_idle: new Animation([
                    new Sprite("demon", [1, 1]),
                    ],
                    1, false),
        memory_idle: new Animation([
                    new Sprite("memory", [1, 1]),
                    ],
                    1, false),
        memory_triggered: new Animation([
                    new Sprite("memory-tr1", [1, 1]),
                    new Sprite("memory-tr2", [1, 1]),
                    ],
                    2, true),
        blackhead_idle: new Animation([
                    new Sprite("blackhead", [1, 1]),
                    new Sprite("blackhead2", [1, 1]),
                    ],
                    10, true),
        whitehead_idle: new Animation([
                    new Sprite("whitehead", [1, 1]),
                    ],
                    1, false),
        whitehead_laser: new Animation([
                    new Sprite("whitehead-laser", [1, 1]),
                    ],
                    1, false),
        blower: new Animation([
                    new Sprite("blower", [1, 1]),
                    ],
                    1, false),
        headsplitter: new Animation([
                    new Sprite("headsplitter", [1, 1]),
                    ],
                    1, false),
        canid_chase: new Animation([
                    new Sprite("canid", [1, 1]),
                    ],
                    1, false),
        canid_hurt: new Animation([
                    new Sprite("canid-hurt", [1, 1]),
                    ],
                    1, false),
        snow: new Animation([
                    new Sprite("snow", [10, 1]),
                    ],
                    1, false),
        forest_guard_idle: new Animation([
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral", [1, 1]),
                    new Sprite("forest-guard-neutral2", [1, 1]),
                    new Sprite("forest-guard-neutral3", [1, 1]),
                    new Sprite("forest-guard-neutral4", [1, 1]),
                    new Sprite("forest-guard-neutral3", [1, 1]),
                    new Sprite("forest-guard-neutral2", [1, 1]),
                    ],
                    10, true),
        forest_guard_roar: new Animation([
                    new Sprite("forest-guard-roar1", [1, 1]),
                    new Sprite("forest-guard-roar2", [1, 1]),
                    new Sprite("forest-guard-roar3", [1, 1]),
                    //new Sprite("forest-guard-roar4", [1, 1]),
                    //new Sprite("forest-guard-roar3", [1, 1]),
                    new Sprite("forest-guard-roar2", [1, 1]),
                    ],
                    6, true),
        lonely_idle: new Animation([
                    new Sprite("lonely-neutral", [1, 1]),
                    ],
                    1, false),
        lonely_pump: new Animation([
                    new Sprite("lonely-neutral", [1, 1]),
                    new Sprite("lonely-blink2", [1, 1]),
                    new Sprite("lonely-blink3", [1, 1]),
                    new Sprite("lonely-blink2", [1, 1]),
                    ],
                    5, true),
        lonely_rollF: new Animation([
                    new Sprite("lonely-neutral", [1, 1]),
                    new Sprite("lonely-neutral2", [1, 1]),
                    new Sprite("lonely-neutral3", [1, 1]),
                    new Sprite("lonely-neutral4", [1, 1]),
                    new Sprite("lonely-neutral5", [1, 1]),
                    new Sprite("lonely-neutral6", [1, 1]),
                    ],
                    8, true),
        lonely_rollB: new Animation([
                    new Sprite("lonely-neutral6", [1, 1]),
                    new Sprite("lonely-neutral5", [1, 1]),
                    new Sprite("lonely-neutral4", [1, 1]),
                    new Sprite("lonely-neutral3", [1, 1]),
                    new Sprite("lonely-neutral2", [1, 1]),
                    new Sprite("lonely-neutral", [1, 1]),
                    ],
                    25, true),
        hostile: new Animation([
                    new Sprite("hostile", [1, 1]),
                    ],
                    1, false),
        zero: new Animation([
                    new Sprite("zero1", [1, 1]),
                    new Sprite("zero2", [1, 1]),
                    new Sprite("zero3", [1, 1]),
                    new Sprite("zero4", [1, 1]),
                    new Sprite("zero5", [1, 1]),
                    new Sprite("zero6", [1, 1]),
                    new Sprite("zero7", [1, 1]),
                    new Sprite("zero8", [1, 1]),
                    new Sprite("zero9", [1, 1]),
                    new Sprite("zero10", [1, 1]),
                    new Sprite("zero11", [1, 1]),
                    new Sprite("zero12", [1, 1]),
                    ],
                    3, true),
        wall: new Animation([
                    new Sprite("wall", [1, 1]),
                    ],
                    1, false),
        reflectorWall: new Animation([
                    new Sprite("reflector1", [1, 1]),
                    new Sprite("reflector2", [1, 1]),
                    new Sprite("reflector3", [1, 1]),
                    new Sprite("reflector4", [1, 1]),
                    ],
                    25, true),
    };
    for(var i in spriteAnimations){
        spriteAnimations[i].init();
    }
    player.animation = spriteAnimations.player_idle;
}
for(var i = 0; i < musics.length; i++){
	musics[i].loop = true;
}

function Entity(X, Y, W, H){
    this.pPosition = {x: X, y: Y};
    this.position = {x: X, y: Y};
    this.velocity = {x: 0, y: 0};
    this.width = W;
    this.height = H;
    this.dead = false;
    this.rotation = 0;
    this.invinciTimer = 0;
}
Entity.prototype.move = function(){
    this.position.x += this.velocity.x;
    this.position.y += this.velocity.y;
}
Entity.prototype.applyFriction = function(){
    this.velocity.x *= GAME.friction;
    this.velocity.y *= GAME.friction;
}
Entity.prototype.applyGravity = function(){
    this.velocity.y += GAME.gravity;
}
Entity.prototype.draw = function(){
    var CTX = GAME.context;
    if(this.animation !== undefined){
        this.animation.draw(-this.width/2, -this.height/2, this.width, this.height);
    }else{
        CTX.fillStyle = this.color;
        CTX.fillRect(-this.width/2, -this.height/2, this.width, this.height);
    }
    CTX.restore();
}
Entity.prototype.applyForce = function(x, y){
    this.velocity.x += x;
    this.velocity.y += y;
}
Entity.prototype.collides = function(obj){
    if(obj instanceof Entity){
        return (this.position.x + this.width > obj.position.x &&
            this.position.x < obj.position.x + obj.width &&
            this.position.y + this.height > obj.position.y &&
            this.position.y < obj.position.y + obj.height);
    }
    return false;
}
Entity.prototype.centerPosition = function(){
    var CTX = GAME.context;
    CTX.save();
    CTX.translate(this.position.x + this.width/2 - GAME.camera.x,
                this.position.y + this.height/2 - GAME.camera.y);
    CTX.rotate(this.rotation);
}
Entity.prototype.onScreen = function(){
    return (this.position.x - GAME.camera.x + this.width > 0 &&
    this.position.x - GAME.camera.x < GAME.canvas.width &&
    this.position.y - GAME.camera.y + this.height > 0 &&
    this.position.y - GAME.camera.y < GAME.canvas.height);
}
Entity.prototype.interact = function(obj){ /*method stub*/ }
Entity.prototype.whenHit = function(obj){ /*method stub*/ }
Entity.prototype.update = function(){ /*method stub*/ }

function Sprite(imageSrc, scale=[1, 1]){
    //File path, String
    this.imageSrc = imageSrc;
    this.scale = {x: scale[0], y: scale[1]};
    this.initImage = function(){
        this.image = document.getElementById(this.imageSrc);
        //console.log(this.image);
    }
    this.draw = function(left, top, width, height){
        //console.log("Good to go!");
        GAME.context.drawImage(this.image,
                                left, top,
                                width * this.scale.x,
                                height * this.scale.y);
    }
}
function Animation(spriteList, frameDelay, autoloop, name=""){
    this.spriteList = spriteList;
    this.frameDelay = frameDelay;
    this.timer = 0;
    this.active = false;
    this.autoloop = autoloop;
    this.currentSprite = 0;
    this.name = name;
    this.init = function(){
        for(var i in this.spriteList){
            this.spriteList[i].initImage();
        }
    }
    this.draw = function(left, top, width, height){
        if(this.timer == this.frameDelay){
            if(this.autoloop || this.currentSprite < this.spriteList.length - 1){
                this.currentSprite++;
                this.currentSprite %= this.spriteList.length;
                this.timer = 0;
            }
        }
        this.spriteList[this.currentSprite].draw(left, top, width, height);
        this.timer++;
    }
    this.reset = function(){
        this.timer = 0;
        this.currentSprite = 0;
    }
}

function Particle(X, Y, W, H, color, duration=10){
    Entity.call(this, X, Y, W, H);
    this.color = color;
    this.duration = duration;
    this.velocity = {x: 0, y: 0};
    this.angularVelocity = Math.random() * 6 - 3;
}
Particle.prototype = Object.create(Entity.prototype);
Particle.prototype.setDuration = function(frames){ this.duration = frames; }
Particle.prototype.setVelocity = function(xVel, yVel){ this.velocity = {x: xVel, y: yVel}; }
Particle.prototype.setAngularVelocity = function(r){ this.angularVelocity = r; }
Particle.prototype.update = function(){
    this.move();
    this.applyFriction();
    this.angularVelocity *= GAME.friction;
    this.draw();
    if(this.duration <= 0){
        this.dead = true;
    }
    this.rotation += this.angularVelocity;
    this.duration--;
}
Particle.prototype.draw = function(){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(-this.width/2, -this.height/2, this.width, this.height);
    CTX.restore();
}

function Snow(X, Y, RAD){
    Particle.call(this, X, Y, RAD, RAD, [255, 255, 255]);
    this.animation = spriteAnimations.snow;
}
Snow.prototype = Object.create(Particle.prototype);
Snow.prototype.update = function(){
    this.move();
    //this.applyFriction();
    this.draw();
    if(!this.onScreen()){
        this.dead = true;
    }
}
Snow.prototype.draw = function(){
    var CTX = GAME.context;
    CTX.globalAlpha = 0.4;
    this.animation.draw(this.position.x, this.position.y, this.width, this.height);
    CTX.globalAlpha = 1;
}

function Bullet(X, Y, W, H, color=[0, 0, 0]){
    Entity.call(this, X, Y, W, H);
    this.color = color; //list format
    this.bounces = 2;
}
Bullet.prototype = Object.create(Entity.prototype);
Bullet.prototype.setVelocity = function(xVel, yVel){ this.velocity = {x: xVel, y: yVel}; }
Bullet.prototype.setUser = function(usr){ this.user = usr; }
Bullet.prototype.update = function(){
    this.move();
    this.draw();
    if(!this.onScreen() || this.bounces <= 0){
        this.dead = true;
        if(this.bounces <= 0){
            sounds.voop.currentTime = 0;
            sounds.voop.play();
        }
    }
}
Bullet.prototype.draw = function(){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(-this.width/2, -this.height/2, this.width, this.height);
    CTX.restore();
}
Bullet.prototype.typeCheck = function(obj){
    if(obj instanceof Player || obj instanceof Enemy){
        var userP = (this.user) instanceof Player;
        var userE = (this.user) instanceof Enemy;
        var objP = obj instanceof Player;
        var objE = obj instanceof Enemy;
        if((userP && objE || userE && objP || this.user === null) && 
        this.collides(obj) && obj.invinciTimer <= 0){
            obj.whenHit();
            return true;
        }
    }
    return false;
}
Bullet.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        obj.hp--;
        if(obj instanceof Player){
            obj.invinciTimer = 75;
            sounds.hurt.currentTime = 0;
            sounds.hurt.play();
        }else{
            sounds.hit.currentTime = 0;
            sounds.hit.play();
        }
        this.dead = true;
        var particles = [];
        for(var i = 0; i < 12; i++){
            particles.push(new Particle(
                this.position.x + this.width/2,
                this.position.y + this.height/2,
                8, 2, [100, 0, 0], 20));
            particles[i].setVelocity(Math.random() * 20 - 10,
                                    Math.random() * 20 - 10);
            entities.push(particles[i]);
        }
    }
}

function LeftistBullet(X, Y){
    Bullet.call(this, X, Y, 8, 8);
    this.color = [100, 0, 0];
}
LeftistBullet.prototype = Object.create(Bullet.prototype);
LeftistBullet.prototype.update = function(){
    this.applyForce(-0.25, 0);
    Bullet.prototype.update.call(this);
}

function ShieldBreaker(X, Y){
    Bullet.call(this, X, Y, 10, 10);
    this.color = [255, 100, 255];
}
ShieldBreaker.prototype = Object.create(Bullet.prototype);
ShieldBreaker.prototype.interact = function(obj){
    if(this.collides(obj) && obj instanceof Shield &&
    !(obj instanceof WindScreen)){
        obj.dead = true;
        obj.user.invinciTimer -= 10;
        obj.user.invinciTimer = Math.max(0, obj.user.invinciTimer);
        sounds.shieldBreak.currentTime = 0;
        sounds.shieldBreak.play();
    }
    Bullet.prototype.interact.call(this, obj);
}

function PowerBullet(X, Y){
    Bullet.call(this, X, Y, 50, 8);
    this.color = [0, 255, 0];
}
PowerBullet.prototype = Object.create(Bullet.prototype);
PowerBullet.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        if(obj instanceof Player){
            obj.hp--;
        }else{
            obj.hp -= 5;
        }
        this.dead = true;
        sounds.boom.currentTime = 0;
        sounds.boom.play();
        var particles = [];
        for(var i = 0; i < 16; i++){
            particles.push(new Particle(
                this.position.x + this.width/2,
                this.position.y + this.height/2,
                20, 10, [100, 0, 100], 20));
            particles[i].setVelocity(Math.random() * 30 - 15,
                                    Math.random() * 30 - 15);
            entities.push(particles[i]);
        }
    }
}

function Firework(X, Y){
    Bullet.call(this, X, Y, 20, 20);
    this.color = [0, 0, 0];
    this.delayTimer = 30;
}
Firework.prototype = Object.create(Bullet.prototype);
Firework.prototype.update = function(){
    Bullet.prototype.update.call(this);
    if(this.delayTimer <= 0){
        for(var i = 0; i < 2 * Math.PI; i += Math.PI/6){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 8, 8,
                                [0, 0, 255]);
            b.setUser(this.user);
            if(!(this.user instanceof Player)){
                b.color = [100, 0, 0];
            }
            b.setVelocity(12 * Math.cos(i), 12 * Math.sin(i));
            entities.push(b);
        }
        this.dead = true;
        sounds.boom.currentTime = 0;
        sounds.boom.play();
    }
    this.delayTimer--;
}
Firework.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        sounds.hit.currentTime = 0;
        sounds.hit.play();
        if(obj instanceof Player){
            obj.hp -= 1;
        }else{
            obj.hp -= 0.5;
        }
        this.dead = true;
    }
}

function Shield(X, Y){
    Bullet.call(this, X, Y, 80, 80);
    this.color = [0, 100, 255];
    this.delayTimer = 30;
}
Shield.prototype = Object.create(Bullet.prototype);
Shield.prototype.draw = function(obj){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.globalAlpha = 0.5;
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(-this.width/2, -this.height/2, this.width, this.height);
    CTX.globalAlpha = 1;
    CTX.restore();
}
Shield.prototype.update = function(){
    Bullet.prototype.update.call(this);
    if(this.delayTimer <= 0){
        this.dead = true;
    }
    this.delayTimer--;
}
Shield.prototype.fix = function(obj){
    if(obj != null){
        this.position.x = obj.position.x + obj.width/2 - this.width/2;
        this.position.y = obj.position.y + obj.height/2 - this.height/2;
    }
}
Shield.prototype.interact = function(obj){
    if(obj instanceof Bullet && this.collides(obj) &&
    (obj.user != this.user || this.user == null) && obj != this &&
    !(obj instanceof WindScreen)){
        obj.dead = true;
        var particles = [];
        for(var i = 0; i < 10; i++){
            particles.push(new Particle(
                obj.position.x + obj.width/2,
                obj.position.y + obj.height/2,
                8, 2, [100, 0, 0], 20));
            particles[i].setVelocity(Math.random() * 10 - 5,
                                    Math.random() * 10 - 5);
            entities.push(particles[i]);
        }
        sounds.hit.currentTime = 0;
        sounds.hit.play();
    }
    this.fix(this.user);
}

function Reflector(X, Y, xOffset=0){
    Shield.call(this, X, Y);
    this.width = 20;
    this.height = 60;
    this.color = [150, 0, 100];
    this.xOffset = xOffset;
}
Reflector.prototype = Object.create(Shield.prototype);
Reflector.prototype.fix = function(obj){
    if(obj != null){
        this.position.x = obj.position.x + obj.width + 10 + this.xOffset;
        this.position.y = obj.position.y + obj.height/2 - this.height/2;
    }
}
Reflector.prototype.interact = function(obj){
    if(
        (obj instanceof Bullet ||
        (obj instanceof Enemy && !(this.user instanceof Enemy)))
        && this.collides(obj) && obj != this &&
        (obj.user != this.user || this.user == null)){
        obj.velocity.x *= -1.25;
        if(obj instanceof Bullet && !(obj instanceof WindScreen) &&
        !(obj instanceof Reflector)){
            obj.setUser(this.user);
            if(this.user instanceof Player){
                obj.color = [0, 0, 255];
            }else{
                obj.color = [255, 0, 0];
            }
        }
        sounds.shieldBlock.currentTime = 0;
        sounds.shieldBlock.play();
    }
    this.fix(this.user);
}

function WindScreen(blowForce=[1.5, 0]){
    Shield.call(this, 0, 0);
    this.width = GAME.canvas.width;
    this.height = 200;
    this.delayTimer = 30;
    this.color = [200, 200, 200];
    this.blowForce = blowForce;
}
WindScreen.prototype = Object.create(Shield.prototype);
WindScreen.prototype.update = function(){
    this.draw();
    if(this.delayTimer <= 0){
        this.dead = true;
    }
    this.delayTimer--;
}
WindScreen.prototype.fix = function(obj){
    if((obj == this.user)){
        this.position.x = 0;
        this.position.y = obj.position.y + obj.height/2 - this.height/2;
    }
}
WindScreen.prototype.interact = function(obj){
    if((obj instanceof Bullet || obj instanceof Enemy || obj instanceof Player)
    && this.collides(obj) && obj != this.user){
        obj.applyForce(this.blowForce[0], this.blowForce[1]);
        if(obj instanceof Bullet && !(obj instanceof WindScreen)){
            if(this.user instanceof Enemy){
                obj.color = [255, 0, 0];
            }
            obj.setUser(null);
        }
    }
    this.fix(obj);
}

function StabRod(X, Y){
    Shield.call(this, X, Y);
    this.width = 50;
    this.height = 10;
    this.delayTimer = 10;
    this.color = [255, 0, 0];
}
StabRod.prototype = Object.create(Shield.prototype);
StabRod.prototype.fix = function(obj){
    if(obj instanceof Player && (this.user) instanceof Player){
        this.position.x = obj.position.x + obj.width;
        this.position.y = obj.position.y + obj.height/2 - this.height/2;
    }
}
StabRod.prototype.interact = function(obj){
    if(
        (obj instanceof Enemy)
        && this.collides(obj) && obj.user != this.user){
        obj.hp -= 5;
        this.dead = true;
        sounds.hit.currentTime = 0;
        sounds.hit.play();
    }
    this.fix(obj);
}

function ForceShot(X, Y){
    Bullet.call(this, X, Y, 15, 50);
    this.color = [255, 200, 0];
}
ForceShot.prototype = Object.create(Bullet.prototype);
ForceShot.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        if(obj instanceof Player){
            obj.hp--;
        }else{
            obj.hp -= 2;
        }
        sounds.hit.currentTime = 0;
        sounds.hit.play();
        if(!obj.isBoss){
            obj.velocity.x = 22;
        }
        if(obj instanceof Player){
            obj.velocity.x = -22;
        }
        this.dead = true;
    }
}

function Enemy(X, Y, W, H){
    Entity.call(this, X, Y, W, H);
    this.color = [0, 0, 0];
    this.hp = 1;
    this.velocity = {x: -1, y: 0};
}
Enemy.prototype = Object.create(Entity.prototype);
Enemy.prototype.update = function(){
    this.move();
    this.draw();
    if(this.position.x + this.width < -100 ||
    this.position.x > GAME.canvas.width + 100 ||
    this.hp <= 0){
        this.dead = true;
    }
}
Enemy.prototype.draw = function(){
    this.centerPosition();
    var CTX = GAME.context;
    if(this.animation !== undefined){
        this.animation.draw(-this.width/2, -this.height/2, this.width, this.height);
    }else{
        CTX.fillStyle = listToColor(this.color);
        CTX.fillRect(-this.width/2, -this.height/2, this.width, this.height);
    }
    if(GAME.debugMode){
        CTX.strokeStyle = listToColor(this.color);
        CTX.strokeRect(-this.width/2, -this.height/2, this.width, this.height);
    }
    CTX.restore();
}
Enemy.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.collides(obj) && obj.invinciTimer <= 0){
            obj.hp--;
            obj.invinciTimer = 75;
			sounds.hurt.currentTime = 0;
			sounds.hurt.play();
        }
    }
}

function Bat(X, Y, variant=1){
    Enemy.call(this, X, Y, 30, 30);
    this.color = [0, 0, 0];
    this.hp = 1;
    this.velocity = {x: -8, y: 0};
    this.variant = variant;
    this.animation = Object.create(spriteAnimations.bat);
}
Bat.prototype = Object.create(Enemy.prototype);
Bat.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.variant > 1){
            if(Math.abs(this.position.y - obj.position.y) < 100){
                this.applyForce(0, -Math.sign(this.position.y - obj.position.y));
            }
            if(this.position.y < 0 || this.position.y > GAME.canvas.height){
                this.velocity.y *= -1;
            }
            if(this.variant > 2){
                if(this.position.x < obj.position.x){
                    this.applyForce(0.5, 0);
                }else{
                    this.applyForce(-0.1, 0);
                }
            }
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Lost(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.color = [0, 0, 0];
    this.hp = 3;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.animation = Object.create(spriteAnimations.lost_walk);
    this.delayTimer = 0;
    if(this.variant > 1){
        this.hp = 5;
    }
}
Lost.prototype = Object.create(Enemy.prototype);
Lost.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
Lost.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        this.applyForce(0.25 * dx/mag, 0.25 * dy/mag);
        if(this.delayTimer >= 125){
            this.delayTimer = 0;
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
            b.setUser(this);
            b.setVelocity(6 * dx/mag, 6 * dy/mag);
            entities.push(b);
            sounds.mehPew.currentTime = 0;
            sounds.mehPew.play();
        }
        if(mag < 200 && mag > 175 && this.variant > 2){
            this.applyForce(15 * dx/mag, 15 * dy/mag);
            sounds.rush.currentTime = 0;
            sounds.rush.play();
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Raven(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.color = [0, 0, 100];
    this.hp = 7;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    this.retreating = true;
    this.animation = Object.create(spriteAnimations.raven_idle);
}
Raven.prototype = Object.create(Enemy.prototype);
Raven.prototype.update = function(){
    this.applyFriction();
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
Raven.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(!this.retreating){
            var dx = obj.position.x - this.position.x;
            var dy = obj.position.y - this.position.y;
            var mag = Math.sqrt(dx ** 2 + dy ** 2);
            this.applyForce(2 * dx/mag, 0.5 * dy/mag);
            if(this.position.x < player.position.x || this.delayTimer > 250){
                this.retreating = true;
                this.delayTimer = 0;
                this.animation = Object.create(spriteAnimations.raven_idle);
            }
        }else{
            var dx = GAME.canvas.width * 0.9 - this.position.x;
            var dy = obj.position.y - this.position.y;
            var mag = Math.sqrt(dx ** 2 + dy ** 2);
            if(this.delayTimer < 150){
                this.applyForce(1 * dx/mag, 3 * Math.cos(this.delayTimer/50 * 2 * Math.PI));
            }
            this.applyForce(0, 0.5 * dy/mag);
            if(this.delayTimer > 175 && 
            Math.abs(this.position.y - player.position.y) < this.height){
                this.retreating = false;
                this.animation = Object.create(spriteAnimations.raven_fly);
            }
        }
    }
    Enemy.prototype.interact.call(this, obj);
}
Raven.prototype.whenHit = function(){
    if(this.variant < 2){
        this.retreating = true;
        this.delayTimer = 0;
        this.animation = Object.create(spriteAnimations.raven_idle);
    }else if(this.variant > 2){
        for(var i = 0; i < 2 * Math.PI; i += Math.PI/3){
            var b = new LeftistBullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 8, 8);
            b.setUser(this);
            b.setVelocity(2 * Math.cos(i), 2 * Math.sin(i));
            entities.push(b);
        }
        sounds.birdScream.currentTime = 0;
        sounds.birdScream.play();
    }
}

function CrossShot(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.color = [255, 128, 0];
    this.hp = 3;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.animation = Object.create(spriteAnimations.cross_limp);
    this.delayTimer = 0;
    if(this.variant > 1){
        this.hp = 5;
    }
}
CrossShot.prototype = Object.create(Enemy.prototype);
CrossShot.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    if(this.rotation > 0){
        this.rotation -= 0.1;
    }else if(this.rotation != 0){
        this.rotation = 0;
    }
    if(this.delayTimer % 10 == 0 && this.delayTimer > 100){
        var b = new Bullet(this.position.x + this.width/2,
                        this.position.y + this.height/2, 10, 10);
        b.setUser(this);
        b.setVelocity(-8, 0);
        entities.push(b);
        sounds.pew.currentTime = 0;
        sounds.pew.play();
        this.rotation = 5 * Math.PI/8;
        if(this.delayTimer == 150 || this.variant == 3){
            for(var i = 3 * Math.PI/4; i < 11 * Math.PI/8; i += Math.PI/8){
                var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
                b.setUser(this);
                b.setVelocity(8 * Math.cos(i), 8 * -Math.sin(i));
                entities.push(b);
            }
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
    }
    if(this.delayTimer > 150){
        this.delayTimer = 0;
    }
    Enemy.prototype.update.call(this);
}
CrossShot.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.delayTimer < 50){
            this.applyForce(-0.3, 1 * Math.sin(this.delayTimer/25 * 2 * Math.PI));
        }
        if(this.delayTimer == 0){
            this.animation = Object.create(spriteAnimations.cross_limp);
        }
        if(this.delayTimer == 50){
            this.animation = Object.create(spriteAnimations.cross_idle);
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Mirage(X, Y, variant=1){
    Enemy.call(this, X, Y, 30, 30);
    this.color = [255, 0, 255];
    this.hp = 1;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    this.animation = spriteAnimations.mirage;
}
Mirage.prototype = Object.create(Enemy.prototype);
Mirage.prototype.draw = function(){
    var CTX = GAME.context;
    CTX.globalAlpha = Math.max((20 - this.delayTimer % 20)/20, 0);
    Enemy.prototype.draw.call(this);
    CTX.restore();
    CTX.globalAlpha = 1;
}
Mirage.prototype.update = function(){
    this.delayTimer++;
    if(this.delayTimer % 20 == 0 && this.delayTimer < 100){
        this.position.x -= 200 * Math.random() + 50;
        this.position.y += 400 * Math.random() - 200 - 
                            (this.position.y - GAME.canvas.height/2);
        if(this.variant > 2){
            for(var i = 0; i < 2 * Math.PI; i += 2 * Math.PI/5){
                var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
                b.setUser(this);
                b.setVelocity(8 * Math.cos(i), 8 * -Math.sin(i));
                entities.push(b);
                sounds.pew.currentTime = 0;
                sounds.pew.play();
            }
        }
    }else if(this.delayTimer > 120){
        this.delayTimer = 0;
    }
    Enemy.prototype.update.call(this);
}
Mirage.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.delayTimer > 100 && this.delayTimer % 5 == 0){
            var dx = obj.position.x - this.position.x;
            var dy = obj.position.y - this.position.y;
            if(this.variant < 2){
                dy = 0;
            }
            var mag = Math.sqrt(dx ** 2 + dy ** 2);
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
            b.setUser(this);
            b.setVelocity(8 * dx/mag, 8 * dy/mag);
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function DemonShape(X, Y, variant=1){
    Enemy.call(this, X, Y, 65, 65);
    this.hp = 25;
    if(this.variant > 1){
        this.hp = 35;
    }
    this.color = [75, 50, 75];
    this.variant = variant;
    this.delayTimer = 0;
    this.animation = spriteAnimations.demonicShape_idle;
}
DemonShape.prototype = Object.create(Enemy.prototype);
DemonShape.prototype.update = function(){
    this.applyFriction();
    this.applyFriction();
    this.applyFriction();
    //He doesn't like to be moved
    this.applyForce(-0.542, 0);
    this.delayTimer++;
    if(this.delayTimer > 125 && this.delayTimer % 5 == 0){
        for(var i = 0; i < 2*Math.PI + 0.0001; i += Math.PI/2){
            var b = new Bullet(
                this.position.x + this.width/2 - 7.5 + 41 * Math.cos(i),
                this.position.y + this.height/2 - 7.5 - 41 * Math.sin(i),
                15, 15);
            b.setUser(this);
            if(this.variant == 1){
                b.setVelocity(-2 + 9 * Math.cos(i),
                9 * -Math.sin(i));
            }else{
                b.setVelocity(-2 + 11 * Math.cos(i),
                11 * -Math.sin(i));
            }
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
    }
    if(this.variant > 2 && this.delayTimer > 100 &&
    this.delayTimer < 125 && this.delayTimer % 5 == 0){
        for(var i = Math.PI/4; i < 9*Math.PI/4 + 0.0001;
        i += Math.PI/2){
            var b = new Bullet(
                this.position.x + this.width/2 - 7.5 + 43 * Math.cos(i),
                this.position.y + this.height/2 - 7.5 - 43 * Math.sin(i),
                15, 15);
            b.setUser(this);
            if(this.variant == 1){
                b.setVelocity(-2 + 9 * Math.cos(i),
                9 * -Math.sin(i));
            }else{
                b.setVelocity(-2 + 11 * Math.cos(i),
                11 * -Math.sin(i));
            }
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
    }
    if(this.delayTimer > 150){
        this.delayTimer = 0;
    }
    Enemy.prototype.update.call(this);
}

function Memory(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.hp = 99999;
    this.dying = false;
    this.color = [200, 200, 200];
    this.variant = variant;
    this.delayTimer = 0;
    this.animation = spriteAnimations.memory_idle;
}
Memory.prototype = Object.create(Enemy.prototype);
Memory.prototype.update = function(){
    this.applyFriction();
    this.applyForce(-0.2, 0);
    if(this.delayTimer <= 100 && this.dying){
        this.delayTimer++;
        if(this.delayTimer % 3 == 0){
            for(var i = 0; i < 4; i++){
                var b = new Bullet(this.position.x + this.width/2,
                                    this.position.y + this.height/2, 10, 10);
                b.setUser(this);
                b.setVelocity(-2 + 6 * Math.cos(i * Math.PI/2 + this.delayTimer/100 * 2 * Math.PI),
                            6 * Math.sin(i * Math.PI/2 + this.delayTimer/100 * 2 * Math.PI));
                entities.push(b);
                sounds.pew.currentTime = 0;
                sounds.pew.play();
            }
        }
    }
    if(this.delayTimer > 100){
        this.dead = true;
        sounds.bossDeath.currentTime = 0;
        sounds.bossDeath.play();
    }
    Enemy.prototype.update.call(this);
}
Memory.prototype.interact = function(obj){
    if(obj instanceof Player && this.collides(obj)){
        this.dead = true;
    }
}
Memory.prototype.whenHit = function(){
    //activate nuke
    this.dying = true;
    this.color = [100, 0, 0];
    this.animation = spriteAnimations.memory_triggered;
}

function WhiteHead(X, Y, variant=1){
    Enemy.call(this, X, Y, 25, 25);
    this.color = [255, 255, 255];
    this.hp = 4;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.animation = Object.create(spriteAnimations.whitehead_idle);
}
WhiteHead.prototype = Object.create(Enemy.prototype);
WhiteHead.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
WhiteHead.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        this.applyForce(0.15 * dx/mag, 0.15 * dy/mag);
        if(this.delayTimer == 100){
            this.aimPos = {DX: dx, DY: dy, MAG: mag};
            this.animation = Object.create(spriteAnimations.whitehead_laser);
        }
        if(this.delayTimer >= 100 && this.delayTimer % 4 == 0){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [255, 0, 0]);
            b.setUser(this);
            b.setVelocity(3 * this.aimPos.DX/this.aimPos.MAG,
                        3 * this.aimPos.DY/this.aimPos.MAG);
            entities.push(b);
            sounds.beam.currentTime = 0;
            sounds.beam.play();
        }
        if(this.delayTimer >= 125){
            this.delayTimer = 0;
            this.animation = Object.create(spriteAnimations.whitehead_idle);
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function BlackHead(X, Y, variant=1){
    Enemy.call(this, X, Y, 25, 25);
    this.color = [0, 0, 0];
    this.hp = 1;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.animation = Object.create(spriteAnimations.blackhead_idle);
}
BlackHead.prototype = Object.create(Enemy.prototype);
BlackHead.prototype.update = function(){
    this.applyFriction();
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
BlackHead.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        if(this.delayTimer < 75){
            this.applyForce(0.8 * dx/mag, 0.8 * dy/mag);
        }else{
            this.applyForce(-0.3 * dx/mag, -0.3 * dy/mag);
        }
        this.applyForce(0.7 * Math.cos(GAME.frameCount/60),
        0.7 * -Math.sin(GAME.frameCount/60));
        if(this.delayTimer % 75 == 0){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [255, 0, 0]);
            b.setUser(this);
            b.setVelocity(7 * dx/mag, 7 * dy/mag);
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
        if(this.delayTimer >= 100){
            this.delayTimer = 0;
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Blower(X, Y, variant=1){
    Enemy.call(this, X, Y, 70, 60);
    this.color = [0, 100, 255];
    this.variant = variant;
    this.delayTimer = 0;
    this.hp = 15;
    if(this.variant > 2){
        this.hp = 21;
    }
    this.firingTime = 180;
    if(this.variant > 1){
        this.firingTime = 140;
    }
    this.animation = spriteAnimations.blower;
}
Blower.prototype = Object.create(Enemy.prototype);
Blower.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    if(this.position.x > GAME.canvas.width * 0.9){
        this.applyForce(-0.5, 0);
    }
    if(this.delayTimer < this.firingTime){
        this.width = this.delayTimer/this.firingTime * 70;
    }else{
        this.width = (1 - (this.delayTimer - this.firingTime)/30) * 70;
    }
    if(this.delayTimer == this.firingTime && this.position.x + this.width > 0){
        var w = new WindScreen([-1, 0]);
        w.setUser(this);
        entities.push(w);
        sounds.wind.currentTime = 0;
        sounds.wind.play();
    }
    if(this.delayTimer > this.firingTime + 30){
        this.delayTimer = 0;
    }
    Enemy.prototype.update.call(this);
}

function HeadSplitter(X, Y, variant=1){
    Enemy.call(this, X, Y, 36, 36);
    this.variant = variant;
    this.delayTimer = 0;
    this.hp = 3;
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.animation = spriteAnimations.headsplitter;
}
HeadSplitter.prototype = Object.create(Enemy.prototype);
HeadSplitter.prototype.update = function(){
    this.applyFriction();
    if(this.position.x < 0 && this.variant > 1){
        this.position.x = 0;
        this.velocity.x *= -1;
    }
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    this.delayTimer++;
    Enemy.prototype.update.call(this);
    if(this.dead){
        var w = new WhiteHead(this.position.x, this.position.y, this.variant);
        w.velocity = {x: 0, y: 0};
        var b = new BlackHead(this.position.x, this.position.y, this.variant);
        b.velocity = {x: 5, y: 0};
        entities.push(w);
        entities.push(b);
        if(this.variant > 2){
            for(var i = 0; i < 16; i++){
                var b = new Bullet(this.position.x + this.width/2,
                                    this.position.y + this.height/2, 10, 10);
                b.setUser(this);
                b.setVelocity(6 * Math.cos(i * Math.PI/8 + this.delayTimer/100 * 2 * Math.PI),
                            6 * Math.sin(i * Math.PI/8 + this.delayTimer/100 * 2 * Math.PI));
                entities.push(b);
                sounds.boom.currentTime = 0;
                sounds.boom.play();
            }
        }
    }
}
HeadSplitter.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        if(this.variant > 1){
            this.applyForce(0.4 * dx/mag, 0.4 * dy/mag);
        }else{
            this.applyForce(0.25 * dx/mag, 0.25 * dy/mag);
        }
        if(this.delayTimer == 100){
            this.aimPos = {DX: dx, DY: dy, MAG: mag};
        }
        if(this.delayTimer >= 100 && this.delayTimer < 125
        && this.delayTimer % 4 == 0){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [255, 0, 0]);
            b.setUser(this);
            b.setVelocity(3 * this.aimPos.DX/this.aimPos.MAG,
                        3 * this.aimPos.DY/this.aimPos.MAG);
            entities.push(b);
            sounds.beam.currentTime = 0;
            sounds.beam.play();
        }
        if(this.delayTimer < 75){
            this.applyForce(0.3 * dx/mag, 0.3 * dy/mag);
        }else{
            this.applyForce(-0.3 * dx/mag, -0.3 * dy/mag);
        }
        if(this.variant > 1){
            this.applyForce(0.7 * Math.cos(GAME.frameCount/40),
        0.7 * -Math.sin(GAME.frameCount/40));
        }else{
            this.applyForce(0.2 * Math.cos(GAME.frameCount/40),
        0.2 * -Math.sin(GAME.frameCount/40));
        }
        if(this.delayTimer % 75 == 0){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [255, 0, 0]);
            b.setUser(this);
            b.setVelocity(7 * dx/mag, 7 * dy/mag);
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
        if(this.delayTimer >= 175){
            this.delayTimer = 0;
        }

    }
    Enemy.prototype.interact.call(this, obj);
}

function Canid(X, Y, variant=1){
    Enemy.call(this, X, Y, 36, 36);
    this.variant = variant;
    this.delayTimer = 0;
    this.hp = 8;
    if(this.variant > 1){
        this.hp = 12;
    }
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.stunTimer = 0;
    this.animation = spriteAnimations.canid_chase;
}
Canid.prototype = Object.create(Enemy.prototype);
Canid.prototype.update = function(){
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    this.applyFriction();
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
Canid.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        if(this.delayTimer == 30 && this.stunTimer == 0){
            this.aimPos = {DX: dx, DY: dy, MAG: mag};
            sounds.bark.currentTime = 0;
            sounds.bark.play();
        }
        if(this.delayTimer > 40){
            this.delayTimer = 0;
        }
        if(this.stunTimer == 0){
            this.applyForce(1.35 * this.aimPos.DX/this.aimPos.MAG, 1.35 * this.aimPos.DY/this.aimPos.MAG);
            this.animation = spriteAnimations.canid_chase;
        }else{
            this.stunTimer--;
            this.animation = spriteAnimations.canid_hurt;
        }
    }
    Enemy.prototype.interact.call(this, obj);
}
Canid.prototype.whenHit = function(){
    this.velocity.x *= -1.5;
    this.velocity.y *= -1.5;
    if(this.variant < 2){
        this.stunTimer += 40;
    }else if(this.variant < 3){
        this.stunTimer += 10;
    }
}

function Charger(X, Y, variant=1){
    Enemy.call(this, X, Y, 36, 36);
    this.variant = variant;
    this.delayTimer = 75;
    this.hp = 11;
    this.color = [0, 0, 255];
    this.retreating = true;
}
Charger.prototype = Object.create(Enemy.prototype);
Charger.prototype.update = function(){
    this.applyFriction();
    if(this.position.x < 0){
        this.position.x = 0;
        this.velocity.x *= -1;
    }
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
Charger.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(!this.retreating){
            var dx = obj.position.x - this.position.x;
            var dy = obj.position.y - this.position.y;
            var mag = Math.sqrt(dx ** 2 + dy ** 2);
            this.applyForce(-3.5, 0);
            if(this.position.x < player.position.x ||
            (this.position.x < 100 && this.velocity.x < 0)){
                this.retreating = true;
                this.delayTimer = 0;
            }
        }else{
            var dx = GAME.canvas.width * 0.9 - this.position.x;
            var dy = obj.position.y - this.position.y;
            var mag = Math.sqrt(dx ** 2 + dy ** 2);
            if(this.delayTimer < 100){
                this.applyForce(2 * dx/mag, 0);
                this.applyForce(0, 0.75 * dy/mag);
            }
            if(this.delayTimer > 150){
                this.retreating = false;
                var s = new Reflector(this.position.x - 35, this.position.y - 35, -this.width - 30);
                s.delayTimer = 125;
                s.setUser(this);
                entities.push(s);
                sounds.shieldStart.currentTime = 0;
                sounds.shieldStart.play();
                sounds.rush.currentTime = 0;
                sounds.rush.play();
            }
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Gong(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.variant = variant;
    this.delayTimer = 0;
    this.hp = 12;
    this.color = [255, 200, 0];
    this.sizeVel = 0;
}
Gong.prototype = Object.create(Enemy.prototype);
Gong.prototype.update = function(){
    this.applyFriction();
    this.applyFriction();
    this.applyFriction();
    if(this.position.x > GAME.canvas.width/3){
        this.applyForce(-0.5, 0);
    }else{
        this.applyForce(1, 0);
    }
    if(this.position.x > GAME.canvas.width * 0.9){
        this.applyForce(-4, 0);
    }
    if(this.width > 40){
        this.sizeVel -= 0.5;
    }else if(this.width < 40){
        this.sizeVel += 0.5;
    }
    this.width += this.sizeVel;
    this.height += this.sizeVel;
    this.sizeVel *= GAME.friction;
    if(this.delayTimer > 0){
        this.delayTimer--;
    }else{
        for(var i = 0; i < 2*Math.PI + 0.0001; i += Math.PI/3){
            var b = new Bullet(
                this.position.x + this.width/2 - 5 + 41 * Math.cos(i),
                this.position.y + this.height/2 - 5 - 41 * Math.sin(i),
                10, 10, [255, 0, 0]);
            b.setUser(this);
            b.setVelocity(-1.845 + 7 * Math.cos(i), 7 * -Math.sin(i));
            entities.push(b);
        }
        sounds.mehPew.currentTime = 0;
        sounds.mehPew.play();
        this.delayTimer = 225;
    }
    Enemy.prototype.update.call(this);
}
Gong.prototype.whenHit = function(){
    this.sizeVel -= 6;
    for(var i = Math.PI/4; i < 2*Math.PI + Math.PI/4 + 0.0001; i += Math.PI/2){
        var b = new Bullet(
            this.position.x + this.width/2 - 7.5 + 41 * Math.cos(i),
            this.position.y + this.height/2 - 7.5 - 41 * Math.sin(i),
            15, 15, [100, 0, 0]);
        b.setUser(this);
        b.setVelocity(-1.845 + 13 * Math.cos(i), 13 * -Math.sin(i));
        entities.push(b);
    }
    sounds.gong.currentTime = 0;
    sounds.gong.play();
}

function Genex(X, Y, variant=1){
    Enemy.call(this, X, Y, 30, 30);
    this.color = [128, 255, 255];
    this.hp = 6;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.initialShield = true;
}
Genex.prototype = Object.create(Enemy.prototype);
Genex.prototype.update = function(){
    this.applyFriction();
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    this.delayTimer++;
    Enemy.prototype.update.call(this);
    if(this.invinciTimer > 0){
        if(this.dead){
            this.dead = false;
            this.hp = 1;
        }
        this.invinciTimer--;
    }
}
Genex.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        if(this.delayTimer % 35 == 0){
            this.aimPos = {DX: dx, DY: dy, MAG: mag};
            sounds.metalBark.currentTime = 0;
            sounds.metalBark.play();
        }
        if(this.delayTimer % 35 < 5){
            this.applyForce(6 * this.aimPos.DX/this.aimPos.MAG, 6 *
            this.aimPos.DY/this.aimPos.MAG);
        }
        /*if(this.delayTimer % 30 == 0){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [0, 0, 0]);
            b.setUser(this);
            b.setVelocity(-7 * dx/mag, -7 * dy/mag);
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }*/
    }
    Enemy.prototype.interact.call(this, obj);
}
Genex.prototype.whenHit = function(){
    if(this.initialShield){
        this.hp = 1;
        this.dead = false;
        this.initialShield = false;
        this.invinciTimer = 10;
        this.color = [128, 255, 128];
        this.velocity.x *= -1.5;
        this.velocity.y *= -1.5;
    }
}
function Soulja(X, Y, variant=1){
    Enemy.call(this, X, Y, 35, 35);
    this.color = [0, 128, 0];
    this.hp = 6;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.delayTimer = 0;
}
Soulja.prototype = Object.create(Enemy.prototype);
Soulja.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    if(this.position.x > GAME.canvas.width * 0.95){
        this.applyForce(-3, 0);
    }
    Enemy.prototype.update.call(this);
}
Soulja.prototype.interact = function(obj){
    this.rawForce = {x: 0, y: 0};
    if(obj instanceof Player){
        if(this.delayTimer % 25 == 0){
            this.aimPos.DX = obj.position.x - this.position.x + 150;
            this.aimPos.DY = obj.position.y - this.position.y;
            this.aimPos.MAG = Math.sqrt(this.aimPos.DX ** 2 +
                                this.aimPos.DY ** 2);
        }
        this.rawForce.x += 0.2 * this.aimPos.DX/this.aimPos.MAG;
        this.rawForce.y += 0.2 * this.aimPos.DY/this.aimPos.MAG;
        if(this.delayTimer % 75 == 0){
            var b = new ShieldBreaker(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [255, 0, 0]);
            b.setUser(this);
            b.setVelocity(13 * this.aimPos.DX/this.aimPos.MAG,
            13 * this.aimPos.DY/this.aimPos.MAG);
            entities.push(b);
            sounds.laserPew.currentTime = 0;
            sounds.laserPew.play();
        }
    var numberOfBullets = 0;
    for(var i = 0; i < entities.length; i++){
        if(entities[i] instanceof Bullet &&
        !(entities[i].user instanceof Enemy)){
            numberOfBullets++;
        }
    }
    if(numberOfBullets > 0){
        for(var i = 0; i < entities.length; i++){
            if(entities[i] instanceof Bullet &&
            !(entities[i].user instanceof Enemy)){
                var dx = entities[i].position.x +
                        entities[i].velocity.x * 8 -
                        this.position.x - this.velocity.x * 8;
                var dy = entities[i].position.y +
                        entities[i].velocity.y * 8 -
                        this.position.y - this.velocity.y * 8;
                var mag = Math.sqrt(dx ** 2 + dy ** 2);
                if(mag < 15 * Math.sqrt(entities[i].velocity.x ** 2 +
                        entities[i].velocity.y ** 2)){
                    this.rawForce.x -= dx/mag * 1/numberOfBullets;
                    this.rawForce.y -= dy/mag * 1/numberOfBullets;
                }
            }
        }
    }
    var fMag = Math.sqrt(this.rawForce.x ** 2 + this.rawForce.y ** 2);
    if(fMag > 0){
        var powerLevel = 1.8 * (1 - ((this.delayTimer + 37) % 75)/75);
        this.applyForce(powerLevel * this.rawForce.x/fMag,
                        powerLevel * this.rawForce.y/fMag);
    }
    Enemy.prototype.interact.call(this, obj);
    }
}


function DoomFairy(X, Y, variant=1){
    Enemy.call(this, X, Y, 80, 80);
    this.color = [255, 0, 0];
    this.hp = 100;
    this.variant = variant;
    if(this.variant > 1){
        this.hp = 125;
    }
    this.delayTimer = 0;
    this.isBoss = true;
    this.animation = Object.create(spriteAnimations.forest_guard_roar);
}
DoomFairy.prototype = Object.create(Enemy.prototype);
DoomFairy.prototype.update = function(){
    if(this.position.x < 0){
        this.position.x = 0;
        this.velocity.x *= -1;
    }
    if(this.position.x + this.width > GAME.canvas.width){
        this.position.x = GAME.canvas.width - this.width;
        this.velocity.x *= -1;
    }
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    this.applyFriction();
    if(this.variant <= 0){
        this.applyFriction();
    }
    if(this.variant < 2){
        this.velocity.x *= 1.1;
        this.velocity.y *= 1.1;
    }else{
        this.velocity.x *= 1.11;
        this.velocity.y *= 1.11;
    }
    this.delayTimer++;
    if(this.delayTimer < 100 && this.delayTimer % 2 == 0 &&
        (this.variant != 0 || this.delayTimer % 4 == 0)){
        for(var i = 0; i < 2; i++){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
            b.setUser(this);
            b.setVelocity(6 * (i * 2 - 1) * Math.cos(this.delayTimer/50 * 2 * Math.PI),
                        6 * (i * 2 - 1) * Math.sin(this.delayTimer/50 * 2 * Math.PI));
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
        }
    }
    if(this.delayTimer == 100){
        this.animation = Object.create(spriteAnimations.forest_guard_idle);
    }
    if(this.delayTimer > 240 && this.delayTimer < 245 && this.variant > 2){
        this.velocity.x = 0;
        this.velocity.y = 0;
    }
    if(this.delayTimer > 300){
        this.delayTimer = 0;
        this.animation = Object.create(spriteAnimations.forest_guard_roar);
    }
    Enemy.prototype.update.call(this);
    if(this.dead){
        GAME.nextLevel();
    }
}
DoomFairy.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.delayTimer < 250 && this.delayTimer > 245){
            var dx = obj.position.x - this.position.x;
            var dy = obj.position.y - this.position.y;
            var mag = Math.sqrt(dx ** 2 + dy ** 2);
            if(this.variant < 2){
                this.applyForce(5 * dx/mag, 5 * dy/mag);
            }else{
                this.applyForce(7 * dx/mag, 7 * dy/mag);
            }
            sounds.rush.currentTime = 0;
            sounds.rush.play();
            this.animation = Object.create(spriteAnimations.forest_guard_roar);
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Blazer(X, Y, variant=1){
    Enemy.call(this, X, Y, 80, 80);
    this.color = [0, 255, 0];
    this.hp = 100;
    this.variant = variant;
    if(this.variant > 1){
        this.hp = 125;
    }
    this.delayTimer = 0;
    this.movingLeft = true;
    this.isBoss = true;
    this.sprayDuration = 150;
    this.animation = Object.create(spriteAnimations.lonely_rollF);
}
Blazer.prototype = Object.create(Enemy.prototype);
Blazer.prototype.update = function(){
    var windActive = false;
    for(var i in entities){
        if(entities[i] instanceof WindScreen){
            windActive = true;
            break;
        }
    }
    this.delayTimer++;
    this.applyFriction();
    if(this.delayTimer % 20 == 0 && (this.variant > 2 || this.delayTimer % 80 == 0)){
        var b = new Bullet(this.position.x + this.width/2 - 30,
                            this.position.y + this.height/2 - 5,
                            40, 10, [255, 0, 0]);
        b.setUser(this);
        b.setVelocity(-10, 0);
        entities.push(b);
        var b = new Bullet(this.position.x + this.width/2 - 30,
                        this.position.y + this.height/2 - 5,
                        40, 10, [255, 0, 0]);
        b.setUser(this);
        b.setVelocity(10, 0);
        entities.push(b);
        sounds.laserPew.currentTime = 0;
        sounds.laserPew.play();
    }
    if(this.delayTimer == 75){
        this.animation = Object.create(spriteAnimations.lonely_idle);
    }
    if(this.delayTimer == 125){
        this.animation = Object.create(spriteAnimations.lonely_pump);
    }
    if(this.delayTimer > 125 &&
    this.delayTimer < 125 + this.sprayDuration &&
    ((this.delayTimer % 2 == 0 && this.variant > 2) ||
    (this.delayTimer % 3 == 0)) && !windActive){
        var angle = Math.PI/2 + 1.5 * Math.cos(
            (this.delayTimer - 75)/(this.sprayDuration/2)
            * Math.PI * 2);
        var b = new Bullet(this.position.x + this.width/2,
                            this.position.y + this.height/2, 10, 10);
        b.setUser(this);
        b.setVelocity(6 * Math.cos(angle),
                    6 * Math.sin(angle));
        entities.push(b);
        var b = new Bullet(this.position.x + this.width/2,
                            this.position.y + this.height/2, 10, 10);
        b.setUser(this);
        b.setVelocity(6 * Math.cos(angle + Math.PI),
                    6 * Math.sin(angle + Math.PI));
        entities.push(b);
        sounds.pew.currentTime = 0;
        sounds.pew.play();
    }
    if(this.delayTimer > 125 + this.sprayDuration){
        if(this.variant > 1 || this.delayTimer > 400){
            this.delayTimer = 0;
            this.animation = Object.create(spriteAnimations.lonely_rollF);
        }else if(this.delayTimer == 126 + this.sprayDuration){
            this.animation = Object.create(spriteAnimations.lonely_rollB);
        }
    }
    Enemy.prototype.update.call(this);
    if(this.dead){
        GAME.nextLevel();
    }
}
Blazer.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.delayTimer < 75){
            this.applyForce(
                0.75 * Math.sign(obj.position.x - this.position.x), 0);
            sounds.uwu.play();
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Hostile(X, Y, variant=1){
    Enemy.call(this, X, Y, 30, 30);
    this.color = [100, 0, 0];
    this.hp = 3;
    this.variant = variant;
    if(this.variant > 1){
        this.hp = 6;
    }
    this.delayTimer = 0;
    this.isBoss = true;
    this.maxSpeed = 1.3;
    if(this.variant > 2){
        this.maxSpeed = 1.6;
    }
    this.rawForce = {x: 0, y: 0};
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.invinciTimer = 0;
    this.animation = Object.create(spriteAnimations.hostile);
}
Hostile.prototype = Object.create(Enemy.prototype);
Hostile.prototype.draw = function(){
    var CTX = GAME.context;
    if(this.invinciTimer > 0 && this.invinciTimer < 10 && this.invinciTimer % 2 == 0){
        CTX.globalAlpha = 0;
    }
    Enemy.prototype.draw.call(this);
    CTX.globalAlpha = 1;
}
Hostile.prototype.update = function(obj){
    this.applyFriction();
    if(this.delayTimer < 100){
        this.delayTimer++;
    }
    if(this.invinciTimer > 0){
       this.invinciTimer--;
    }
    if(this.rotation < 0){
        this.rotation += 0.15;
    }else if(this.rotation != 0){
        this.rotation = 0;
    }
    if(this.position.x < 0){
        this.position.x = 0;
        this.velocity.x *= -1;
    }
    if(this.position.x + this.width > GAME.canvas.width){
        this.position.x = GAME.canvas.width - this.width;
        this.velocity.x *= -1;
    }
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    Enemy.prototype.update.call(this);
    if(this.dead){
        GAME.nextLevel();
    }
}
Hostile.prototype.interact = function(obj){
    this.rawForce = {x: 0, y: 0};
    if(obj instanceof Player){
        if(GAME.frameCount % 30 == 0 || this.delayTimer < 5){
            this.aimPos.DX = obj.position.x - this.position.x + 150;
            this.aimPos.DY = obj.position.y - this.position.y;
            this.aimPos.MAG = Math.sqrt(this.aimPos.DX ** 2 +
                                this.aimPos.DY ** 2);
        }
        if(this.delayTimer > 50){
            this.rawForce.x += this.aimPos.DX/this.aimPos.MAG;
            this.rawForce.y += this.aimPos.DY/this.aimPos.MAG;
        }
        if(this.position.x < 100){
            this.rawForce.x += 20;
        }
        if(Math.abs(obj.position.y - obj.position.y) < 30 &&
            this.position.x > obj.position.x){
            if(this.delayTimer >= 20 && Math.random() < 0.03){
                var angle = 15 * Math.PI/180;
                var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 8, 8,
                                [100, 0, 0]);
                b.setUser(this);
                b.setVelocity(-8, 0);
                entities.push(b);
                sounds.pew.currentTime = 0;
                sounds.pew.play();
                this.rotation = -Math.PI/2;
                this.delayTimer -= 20;
            }
        }else if(Math.random() < 0.03 && this.position.x > 300 &&
        this.variant > 2){
            var b = new Firework(this.position.x + this.width/2,
                        this.position.y + this.height/2);
            b.setUser(this);
            b.setVelocity(-12, 0);
            entities.push(b);
            sounds.pew.currentTime = 0;
            sounds.pew.play();
            this.rotation = -Math.PI/2;
        }
    }
    var numberOfBullets = 0;
    for(var i = 0; i < entities.length; i++){
        if(entities[i] instanceof Bullet &&
        !(entities[i].user instanceof Enemy)){
            numberOfBullets++;
        }
    }
    if(numberOfBullets > 0){
        for(var i = 0; i < entities.length; i++){
            if(entities[i] instanceof Bullet &&
            !(entities[i].user instanceof Enemy)){
                var dx = entities[i].position.x +
                        entities[i].velocity.x * 8 -
                        this.position.x - this.velocity.x * 8;
                var dy = entities[i].position.y +
                        entities[i].velocity.y * 8 -
                        this.position.y - this.velocity.y * 8;
                var mag = Math.sqrt(dx ** 2 + dy ** 2);
                if(mag < 5 * Math.sqrt(entities[i].velocity.x ** 2 +
                        entities[i].velocity.y ** 2) && this.delayTimer >= 40){
                    var s = new Shield(this.position.x - 35, this.position.y - 35);
                    s.setUser(this);
                    entities.push(s);
                    this.invinciTimer = 10;
                    this.delayTimer -= 40;
                    sounds.shieldStart.currentTime = 0;
                    sounds.shieldStart.play();
                }else if(mag < 15 * Math.sqrt(entities[i].velocity.x ** 2 +
                        entities[i].velocity.y ** 2)){
                    this.rawForce.x -= dx/mag * 1/numberOfBullets;
                    this.rawForce.y -= dy/mag * 1/numberOfBullets;
                }
            }
        }
    }
    var fMag = Math.sqrt(this.rawForce.x ** 2 + this.rawForce.y ** 2);
    if(fMag > 0){
        this.applyForce(this.maxSpeed * this.rawForce.x/fMag,
                        this.maxSpeed * this.rawForce.y/fMag);
    }
    Enemy.prototype.interact.call(this, obj);
}
Hostile.prototype.whenHit = function(){
    this.invinciTimer = 75;
    sounds.otherHurt.currentTime = 0;
    sounds.otherHurt.play();
}

function PatientZero(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.color = [255 * Math.random(),
                    255 * Math.random(),
                    255 * Math.random()];
    this.hp = 100;
    this.variant = variant;
    if(this.variant > 1){
        this.hp = 125;
    }
    this.delayTimer = 100;
    //0: IDLE
    //1: Bullet Storm
    //2: Megalaser
    //3: Line Dancer
    //Teleports behind you when you're blowing
    //Blows you when you're shielding
    this.phase = 0;
    this.randomize = false;
    this.isBoss = true;
    this.aimPos = {DX: 0, DY: 0, MAG: 1};
    this.windTimer = 0;
    this.seed = Math.random();
    this.nextPhase = 1;
    this.animation = Object.create(spriteAnimations.zero);
}
PatientZero.prototype = Object.create(Enemy.prototype);
PatientZero.prototype.update = function(){
    this.applyFriction();
    var shieldActive = false;
    for(var i in entities){
        if(entities[i] instanceof Shield && entities[i].user instanceof Player){
            shieldActive = true;
            break;
        }
    }
    if(this.position.x > GAME.canvas.width - 50){
        this.applyForce(-2, 0);
    }
    if(shieldActive && this.windTimer == 0 && this.phase > 2){
        var w = new WindScreen([-1, 0]);
        w.setUser(this);
        entities.push(w);
        sounds.wind.currentTime = 0;
        sounds.wind.play();
        this.windTimer = 30;
        sounds.no.currentTime = 0;
        sounds.no.play();
    }
    if(this.windTimer > 0){
        this.windTimer--;
    }
    if(this.phase == 0){
        if(this.delayTimer <= 0){
           this.seed = Math.random();
           if(!this.randomize){
               this.phase = this.nextPhase;
               this.nextPhase++;
               if(this.nextPhase > 3){
                   this.randomize = true;
               }
               this.delayTimer = 200;
               this.position.x = GAME.canvas.width/2 - this.width/2;
               this.position.y = GAME.canvas.height/2 - this.height/2;
           }else{
               this.phase = Math.floor(Math.random() * 3) + 1;
               this.delayTimer = 200;
               this.position.x = GAME.canvas.width/2 - this.width/2;
               this.position.y = GAME.canvas.height/2 - this.height/2;
           }
        }
    }else{
        if(this.delayTimer <= 0){
            this.phase = 0;
            this.delayTimer = 250;
            if(this.variant > 1){
                this.delayTimer = 150;
            }
        }
    }
    if(this.phase == 1){
        if(this.delayTimer % 6 == 0){
            for(var i = 0; i < 3; i++){
                var b = new Bullet(this.position.x + this.width/2,
                                    this.position.y + this.height/2, 10, 10);
                if(this.variant > 1){
                    b = new ShieldBreaker(this.position.x + this.width/2,
                                    this.position.y + this.height/2);
                }
                b.setUser(this);
                var mult = 4;
                if(this.variant > 1){
                    mult = 5;
                }
                b.setVelocity(-2 + mult * Math.cos(i * 2 * Math.PI/3 + (this.delayTimer/200 + this.seed) * 2 * Math.PI),
                            mult * Math.sin(i * 2 * Math.PI/3 + (this.delayTimer/200 + this.seed) * 2 * Math.PI));
                entities.push(b);
                sounds.pew.currentTime = 0;
                sounds.pew.play();
            }
        }
    }
    if(this.phase == 2){
        if(this.delayTimer % 25 == 0){
            if(this.delayTimer % 2 == 0){
                this.position.x = 100;
            }else{
                this.position.x = GAME.canvas.width - 100 - this.width;
            }
            this.position.y = Math.random() * 550;
        }
    }
    if(this.phase == 3){
        this.position.x = GAME.canvas.width - this.width;
        this.applyForce(0.5, 0);
        if(this.delayTimer % 35 == 0){
            var gap = 80;
            if(this.variant > 1){
                gap = 75;
            }
            for(var i = -8; i < 8; i++){
                var b = new Bullet(1159,
                            this.position.y + this.height/2 + i * gap
                + 50 * Math.sin(GAME.frameCount/20), 10, 10);
                b.setUser(this);
                b.setVelocity(-8, 0);
                entities.push(b);
            }
            sounds.bulletScreen.currentTime = 0;
            sounds.bulletScreen.play();
         }
    }
    this.delayTimer--;
    Enemy.prototype.update.call(this);
    if(this.dead){
        if(GAME.difficulty == 0){
            alert("Good job! You beat the game.");
            alert("Now it's time for a REAL challenge...");
            alert("Hard Mode.");
            GAME.level = 1;
            GAME.frameCount = 0;
            player.hp = 3;
            GAME.difficulty = 1;
            entities = [];
            backgroundTiles = [];
            spawnedStart = false;
            GAME.save();
            GAME.level = 0;
            GAME.handleBGM();
            sounds.bossDeath.play();
        }else{
            alert("Good job! You beat the game. Again.");
            alert("Press Shift-R to restart your progress.");
            alert("Or you can play through the first 3 levels of Extreme");
            GAME.level = 1;
            GAME.frameCount = 0;
            player.hp = 3;
            GAME.difficulty = 2;
            entities = [];
            backgroundTiles = [];
            spawnedStart = false;
            GAME.save();
            GAME.level = 0;
            GAME.handleBGM();
            sounds.bossDeath.play();
        }
    }
}
PatientZero.prototype.interact = function(obj){
    if(this.phase == 2){
        if(this.delayTimer % 25 == 24 && obj instanceof Player){
            this.aimPos.DX = obj.position.x - this.position.x;
            this.aimPos.DY = obj.position.y - this.position.y;
            this.aimPos.MAG = Math.sqrt(this.aimPos.DX ** 2 + this.aimPos.DY ** 2);
        }
        if(this.delayTimer % 2 == 0 && this.delayTimer % 25 < 20){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10,
                                [255, 0, 0]);
            if(this.variant > 1 && this.delayTimer % 20 == 0){
                b = new ShieldBreaker(this.position.x + this.width/2,
                                this.position.y + this.height/2);
            }
            b.setUser(this);
            b.setVelocity(12 * this.aimPos.DX/this.aimPos.MAG,
                        12 * this.aimPos.DY/this.aimPos.MAG);
            entities.push(b);
            sounds.beam.currentTime = 0;
            sounds.beam.play();
        }
    }
    if(this.phase == 3){
        if(this.delayTimer % 10 == 0 && obj instanceof Player){
            this.position.y = Math.random() * 550;
        }
    }
    Enemy.prototype.interact.call(this, obj);
}
PatientZero.prototype.whenHit = function(){
    this.color = [255 * Math.random(),
                    255 * Math.random(),
                    255 * Math.random()];
}

function UtilityObj(X, Y, W, H){
    Entity.call(this, X, Y, W, H);
}
UtilityObj.prototype = Object.create(Entity.prototype);

function Wall(X, Y, W, H, variant=1, XVel=-2, YVel=0){
    UtilityObj.call(this, X, Y, W, H);
    this.variant = variant;
    this.color = [0, 0, 0];
    this.animation = Object.create(spriteAnimations.wall);
    if(this.variant > 1){
        this.color = [100, 0, 255];
        this.animation = Object.create(spriteAnimations.reflectorWall);
    }
    this.hp = 999;
    this.velocity = {x: XVel, y: YVel};
}
Wall.prototype = Object.create(UtilityObj.prototype);
Wall.prototype.update = function(){
    Enemy.prototype.update.call(this);
}
Wall.prototype.draw = function(){
    Enemy.prototype.draw.call(this);
}
Wall.prototype.interact = function(obj){
    if((obj instanceof Player || obj instanceof Enemy ||
    (obj instanceof Bullet && !(obj instanceof Shield)
    && this.variant > 1)) && 
    this.collides(obj) && !(obj instanceof Wall)){
        //Left
        if(obj.position.x + obj.width > this.position.x &&
        obj.position.x + obj.width < this.position.x + 20){
            obj.position.x = this.position.x - obj.width;
            obj.velocity.x *= -1;
            if(this.position.x < obj.width){
                obj.hp -= 999;
                sounds.bossDeath.currentTime = 0;
                sounds.bossDeath.play();
            }
        }
        //Right
        if(obj.position.x < this.position.x + this.width &&
        obj.position.x > this.position.x + this.width - 20){
            obj.position.x = this.position.x + this.width;
            obj.velocity.x *= -1;
        }
        //Up
        if(obj.position.y + obj.height > this.position.y &&
        obj.position.y + obj.height < this.position.y + 20){
            obj.position.y = this.position.y - obj.height;
            obj.velocity.y *= -1;
        }
        //Down
        if(obj.position.y < this.position.y + this.height &&
        obj.position.y > this.position.y + this.height - 20){
            obj.position.y = this.position.y + this.height;
            obj.velocity.y *= -1;
        }
        if(obj instanceof Bullet){
            obj.bounces--;
            sounds.wallBlock.currentTime = 0;
            sounds.wallBlock.play();
        }
    }
    if(obj instanceof Bullet && !(obj instanceof Shield)
    && this.collides(obj)){
        if(this.variant == 1){
            obj.dead = true;
        }
    }
}

function Text(X, Y, TEXT, size=20, color=[0, 0, 0], duration=80){
    Entity.call(this, X, Y, 0, 0);
    this.text = TEXT;
    this.size = size;
    this.color = color;
    this.duration = duration;
    this.delayTimer = duration;
}
Text.prototype = Object.create(Entity.prototype);
Text.prototype.draw = function(){
    var CTX = GAME.context;
    CTX.globalAlpha = Math.max((this.delayTimer/this.duration), 0);
    CTX.fillStyle = listToColor(this.color);
    CTX.font = this.size + "px Tahoma";
    CTX.textAlign = "center";
    CTX.fillText(this.text, this.position.x, this.position.y);
    CTX.globalAlpha = 1;
}
Text.prototype.update = function(){
    if(this.delayTimer <= 0){
        this.dead = true;
    }
    this.delayTimer--;
}

function Button(X, Y, W, H, text, color=[255, 0, 0], tColor = [255, 255, 255]){
    UtilityObj.call(this, X, Y, W, H);
    this.text = text;
    this.color = color;
    this.tColor = tColor;
    this.textSize = 20;
}
Button.prototype = Object.create(UtilityObj.prototype);
Button.prototype.draw = function(){
    var CTX = GAME.context;
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(this.position.x, this.position.y, this.width, this.height);
    CTX.fillStyle = listToColor(this.tColor);
    CTX.textAlign = "center";
    CTX.font = this.textSize + "px Tahoma";
    CTX.fillText(this.text, this.position.x + this.width/2,
                this.position.y + this.textSize);
}
Button.prototype.doStuff = function(){ }
Button.prototype.interact = function(obj){
    if(this.collides(obj) && obj instanceof Player){
        this.doStuff();
    }
}

function Player(X, Y, W, H){
    Entity.call(this, X, Y, W, H);
    this.goingLeft = false;
    this.goingRight = false;
    this.goingUp = false;
    this.goingDown = false;
    this.delayTimer = 0;
    this.hp = 3;
    this.invinciTimer = 0;
    this.color = [255, 0, 0];
}
Player.prototype = Object.create(Entity.prototype);
Player.prototype.update = function(){
    if(this.goingLeft){
        this.applyForce(-0.75, 0);
    }
    if(this.goingRight){
        this.applyForce(0.75, 0);
    }
    if(this.goingUp){
        this.applyForce(0, -0.75);
    }
    if(this.goingDown){
        this.applyForce(0, 0.75);
    }
    if(this.delayTimer < 100){
        this.delayTimer++;
    }
    if(this.invinciTimer > 0){
        this.invinciTimer--;
    }
    if(this.rotation < 0){
        this.rotation += 0.15;
    }else if(this.rotation != 0){
        this.rotation = 0;
    }
    if(this.position.x < 0){
        this.position.x = 0;
        this.velocity.x *= -1;
    }
    if(this.position.x + this.width > GAME.canvas.width){
        this.position.x = GAME.canvas.width - this.width;
        this.velocity.x *= -1;
    }
    if(this.position.y < 0){
        this.position.y = 0;
        this.velocity.y *= -1;
    }
    if(this.position.y + this.height > GAME.canvas.height){
        this.position.y = GAME.canvas.height - this.height;
        this.velocity.y *= -1;
    }
    //GAME.camera.x = this.position.x - GAME.canvas.width/2 + this.width/2;
    //GAME.camera.y = this.position.y - GAME.canvas.height/2 + this.height/2;
    //console.log(player.velocity.y);
    this.move();
    this.applyFriction();
    this.draw();
}
Player.prototype.draw = function(){
    var CTX = GAME.context;
    var color = [255, 0, 0];
    this.centerPosition();
    if(this.invinciTimer > 0 && this.invinciTimer % 2 == 0){
        CTX.globalAlpha = 0;
    }
    if(this.animation !== undefined){
        this.animation.draw(-this.width/2, -this.height/2, this.width, this.height);
    }
    CTX.globalAlpha = 1;
    if(GAME.debugMode){
        CTX.strokeStyle = listToColor(this.color);
        CTX.strokeRect(-this.width/2, -this.height/2, this.width, this.height);
    }
    CTX.restore();
}
function drawForeground(){
    var CTX = GAME.context;
    if(GAME.level == 3){
        CTX.globalAlpha = 0.5;
        CTX.fillStyle = "#FAFAFA";
        CTX.fillRect(0, 0, GAME.canvas.width, GAME.canvas.height);
        CTX.globalAlpha = 1;
        if(Math.random() < 0.25){
            var s = new Snow(GAME.canvas.width - 1, Math.random() * GAME.canvas.height, Math.random() * 10 + 5);
            s.setVelocity(-10, 0);
            entities.push(s);
        }
    }
    CTX.fillStyle = "#FF0000";
    CTX.fillRect(15, 15, player.delayTimer * 2, 15);
    for(var i = 0; i < player.hp; i++){
        CTX.fillRect(15 + 20 * i, 45, 15, 15);
    }
    if(player.hp <= 0){
        GAME.pause();
        alert("GAME OVER!\nUnpause (press P) to try again.");
        for(var i = 0; i < musics.length; i++){
            musics[i].pause();
        }
        GAME.restart();
    }
    if(GAME.frameCount < GAME.levelLengths[GAME.level - 1]){
        CTX.fillStyle = "#FEFE99";
        CTX.fillRect(15, 75, 200, 15);
        CTX.fillStyle = "#FF0000";
        CTX.fillRect(15, 75,
                200 * GAME.frameCount/GAME.levelLengths[GAME.level - 1], 15);
    }else{
        CTX.fillStyle = "#99AAAA";
        var boss = {hp: 0};
        for(var i in entities){
            if(entities[i].isBoss){
                boss = entities[i];
            }
        }
        CTX.fillRect(15, 75,
                3 * boss.hp, 15);
    }
}

var BGs = [  //Who ya gonna call? Not the Bee Geeeees
    "cityBG",
    "forestBG",
    "cityBG",
    "mountainBG",
    "labBG",
];
var backgroundTiles = [];
var backgroundTimer = 0;
var spawnedStart = false;

function BackgroundTile(imageSrc, X, XVel=-2){
    this.position = {x: X, y: 0};
    this.imageSrc = imageSrc;
    this.xVel = XVel;
    this.dead = false;
    this.initImage = function(){
        this.image = document.getElementById(this.imageSrc);
        //console.log(this.image);
    }
    this.draw = function(left, top, width, height){
        //console.log("Good to go!");
        GAME.context.drawImage(this.image,
                                this.position.x, 0,
                                GAME.canvas.width,
                                GAME.canvas.height);
        if(this.position.x + GAME.canvas.width < 0){
            this.dead = true;
        }
        this.position.x += this.xVel;
    }
}

function spawnBackground(){
    if(backgroundTimer == 0 && GAME.level > 0 &&
        Number.isInteger(GAME.level)){
        var b = new BackgroundTile(BGs[GAME.level], GAME.canvas.width);
        b.initImage();
        backgroundTiles.push(b);
        backgroundTimer = 600;
        if(!spawnedStart){
            var b = new BackgroundTile(BGs[GAME.level], GAME.canvas.width);
            b.initImage();
            b.position.x = 0;
            backgroundTiles.push(b);
            spawnedStart = true;
        }
    }
    if(backgroundTimer > 0){
        backgroundTimer--;
    }
}

function drawBackground(){
    for(var i = 0; i < backgroundTiles.length; i++){
        backgroundTiles[i].draw();
        if(backgroundTiles[i].dead){
            backgroundTiles.splice(i, 1);
        }
    }
}

function PWeapon(name, charge){
    this.name = name;
    this.charge = charge;
}
PWeapon.prototype.fire = function(){
    if(player.delayTimer >= this.charge){
        this.pewpew();
        player.delayTimer -= this.charge;
    }
}
PWeapon.prototype.pewpew = function(){
    //stub method
}

function W_Peashooter(){
    PWeapon.call(this, "Peashooter", 7);
}
W_Peashooter.prototype = Object.create(PWeapon.prototype);
W_Peashooter.prototype.pewpew = function(){
    var b = new Bullet(player.position.x + player.width/2,
                            player.position.y + player.height/2, 8, 8,
                            [0, 0, 255]);
    b.setUser(player);
    b.setVelocity(12, 0);
    entities.push(b);
    player.rotation = -0.7 * Math.PI;
    sounds.pew.currentTime = 0;
    sounds.pew.play();
}

function W_TripleShot(){
    PWeapon.call(this, "Triple Shot", 20);
}
W_TripleShot.prototype = Object.create(PWeapon.prototype);
W_TripleShot.prototype.pewpew = function(){
    var angle = 15 * Math.PI/180;
    for(var i = -angle; i <= angle; i += angle){
        var b = new Bullet(player.position.x + player.width/2,
                                player.position.y + player.height/2, 8, 8,
                                [0, 0, 255]);
        b.setUser(player);
        b.setVelocity(12 * Math.cos(i), -12 * Math.sin(i));
        entities.push(b);
    }
    player.rotation = -0.7 * Math.PI;
    sounds.pew.currentTime = 0;
    sounds.pew.play();
}

function W_Blaster(){
    PWeapon.call(this, "Power Blaster", 32);
}
W_Blaster.prototype = Object.create(PWeapon.prototype);
W_Blaster.prototype.pewpew = function(){
    var b = new PowerBullet(player.position.x + player.width/2,
                            player.position.y + player.height/2);
    b.setUser(player);
    b.setVelocity(15, 0);
    entities.push(b);
    player.rotation = -0.7 * Math.PI;
    sounds.laserPew.currentTime = 0;
    sounds.laserPew.play();
}

function W_FireworkLauncher(){
    PWeapon.call(this, "Firework", 25);
}
W_FireworkLauncher.prototype = Object.create(PWeapon.prototype);
W_FireworkLauncher.prototype.pewpew = function(){
    var b = new Firework(player.position.x + player.width/2,
                        player.position.y + player.height/2);
    b.setUser(player);
    b.setVelocity(12, 0);
    entities.push(b);
    player.rotation = -0.7 * Math.PI;
    sounds.pew.currentTime = 0;
    sounds.pew.play();
}

function W_Shield(){
    PWeapon.call(this, "Shield", 40);
}
W_Shield.prototype = Object.create(PWeapon.prototype);
W_Shield.prototype.pewpew = function(){
    var s = new Shield(player.position.x, player.position.y);
    s.setUser(player);
    player.invinciTimer = 30;
    entities.push(s);
	sounds.shieldStart.currentTime = 0;
	sounds.shieldStart.play();
}

function W_Reflector(){
    PWeapon.call(this, "Reflector", 40);
}
W_Reflector.prototype = Object.create(PWeapon.prototype);
W_Reflector.prototype.pewpew = function(){
    var r = new Reflector(player.position.x, player.position.y);
    r.setUser(player);
    player.invinciTimer = 25;
    entities.push(r);
	sounds.shieldStart.currentTime = 0;
	sounds.shieldStart.play();
}

function W_Wind(){
    PWeapon.call(this, "Divine Wind", 100);
}
W_Wind.prototype = Object.create(PWeapon.prototype);
W_Wind.prototype.pewpew = function(){
    var w = new WindScreen();
    w.setUser(player);
    entities.push(w);
    sounds.wind.currentTime = 0;
    sounds.wind.play();
}

function W_ForceShooter(){
    PWeapon.call(this, "Force Shooter", 20);
}
W_ForceShooter.prototype = Object.create(PWeapon.prototype);
W_ForceShooter.prototype.pewpew = function(){
    var b = new ForceShot(player.position.x + player.width/2,
                            player.position.y + player.height/2 - 25);
    b.setUser(player);
    b.setVelocity(20, 0);
    entities.push(b);
    player.rotation = -0.7 * Math.PI;
	sounds.weirdPew.currentTime = 0;
	sounds.weirdPew.play();
}

function W_StabRod(){
    PWeapon.call(this, "Stab Rod", 10);
}
W_StabRod.prototype = Object.create(PWeapon.prototype);
W_StabRod.prototype.pewpew = function(){
    var s = new StabRod(player.position.x, player.position.y);
    s.setUser(player);
    entities.push(s);
}

var entities = [];
var player = new Player(0, 0, 30, 30);
var initTime = 0;
var weapons = [
    new W_Peashooter(),
    new W_Blaster(),
    new W_FireworkLauncher(),
    new W_Shield(),
    new W_Reflector(),
    new W_Wind(),
    new W_ForceShooter(),
    new W_TripleShot(),
    new W_StabRod()
];
var rWeapons = weapons.slice();
rWeapons.sort( function() { return 0.5 - Math.random() } );

player.weapons = [rWeapons[5], rWeapons[1], rWeapons[3]];
document.onkeydown = function(e){
    if(e.keyCode == 16){
        shifting = true;
    }
    if(e.keyCode == 82 && shifting){ //R, reset
        if(confirm("Are you sure you want to restart your progress?")){
            localStorage.Shooter = "";
            window.location.reload();
        }
    }
    if(e.keyCode == 80){ //P, pause
        if(GAME.isPaused){
            GAME.activate();
        }else{
            GAME.pause();
        }
        sounds.pause.currentTime = 0;
        sounds.pause.play();
    }
    if(e.keyCode == 77){ //M, mute
        if(GAME.musicVolume == 1){
            GAME.musicVolume = 0;
        }else if(GAME.musicVolume == 0){
            GAME.musicVolume = 1;
        }
        for(var i = 0; i < musics.length; i++){
            musics[i].volume = GAME.musicVolume;
        }
    }
    if(e.keyCode == 49){
        GAME.difficulty = 0;
        entities.push(new Text(600, 300,
                    "Now playing on Normal difficulty.", 30, [0, 0, 0], 50));
    }
    if(e.keyCode == 50){
        GAME.difficulty = 1;
        entities.push(new Text(600, 300,
                    "Now playing on Hard difficulty.", 30, [0, 0, 0], 50));
    }
    if(e.keyCode == 51){
        GAME.difficulty = 2;
        entities.push(new Text(600, 300,
                    "Now playing on EXTREME difficulty.", 30, [0, 0, 0], 50));
    }
    if(player.hp > 0 && !GAME.isPaused){
        if(Number.isInteger(GAME.level)){
            musics[GAME.level].play();
        }
        e = e || window.event;
        if(e.keyCode == 37){ //Left
            player.goingLeft = true;
        }
        if(e.keyCode == 39){ //Right
            player.goingRight = true;
        }
        if(e.keyCode == 38){ //Up
            player.goingUp = true;
        }
        if(e.keyCode == 40){ //Down
            player.goingDown = true;
        }
        if(e.keyCode == 16){ //Shift
            player.velocity.x *= -1;
            player.velocity.y *= -1;
        }
        if(e.keyCode == 90){ //Z, shoot primary weapon
            if(player.weapons[0] != null){
                player.weapons[0].fire();
            }
        }
        if(e.keyCode == 88){ //X, shoot secondary weapon
            if(player.weapons[1] != null){
                player.weapons[1].fire();
            }
        }
        if(e.keyCode == 67){ //C, shoot tertiary weapon
            if(player.weapons[2] != null){
                player.weapons[2].fire();
            }
        }
        if(e.keyCode == 79){ //O, skip level
            GAME.level++;
            GAME.frameCount = 0;
            player.hp = 3;
            GAME.handleBGM();
            sounds.bossDeath.play();
        }
        if(e.keyCode == 81){ //Q, fast-forward
            GAME.frameCount = Number(prompt());
        }
    }
}
document.onkeyup = function(e){
    e = e || window.event;
    if(e.keyCode == 16){
        shifting = false;
    }
    if(e.keyCode == 37){ //Left
        player.goingLeft = false;
    }
    if(e.keyCode == 39){ //Right
        player.goingRight = false;
    }
    if(e.keyCode == 38){ //Up
        player.goingUp = false;
    }
    if(e.keyCode == 40){ //Down
        player.goingDown = false;
    }
}

var menuEntities = [
    new Button(600 - 175, 400, 150, 25, "Start"),
    new Button(600 + 25, 400, 150, 25, "Instructions"),
    new Text(600, 150,
                                "XINDEXIN", 80, [0, 0, 0], Infinity),
    new Text(600, 240,
                                "新的心", 30, [0, 0, 0], Infinity),
    new Text(600, 300,
                                "Arrow keys to move.", 30, [0, 0, 0], 150),
];
menuEntities[0].doStuff = function(){
    GAME.load();
    sounds.enter.currentTime = 0;
    sounds.enter.play();
    GAME.handleBGM();
}
menuEntities[1].doStuff = function(){
    entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 - 30,
                                "Arrow keys to move.", 30, [0, 0, 0], 150));
    entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Z/X/C to use weapons (randomly selected every game)", 30, [0, 0, 0], 150));
    entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 30,
                                "P to Pause/Unpause.", 30, [0, 0, 0], 150));
    entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 60,
                                "M to Mute/Unmute music.", 30, [0, 0, 0], 150));
    player.position.x = 0;
    player.position.y = 0;
    sounds.enter.currentTime = 0;
    sounds.enter.play();
}
function init(){
    GAME.start();
    GAME.activate();
}

function handleCheckpoints(){
    if(GAME.difficulty < 2 && Number.isInteger(GAME.level)){
        if(
        (GAME.frameCount == GAME.levelLengths[GAME.level - 1]/2 &&
            GAME.level < 4) ||
        (GAME.frameCount % (GAME.levelLengths[GAME.level - 1]/3) == 0 &&
        GAME.frameCount < 12500 && GAME.frameCount > 0 &&
            GAME.level >= 4)){
            entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "CHECKPOINT!", 30, [0, 0, 0], 150));
            entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 30,
                                "(Game saved.)", 20, [100, 100, 100], 150));
            player.hp = 3;
            sounds.collect.currentTime = 0;
            sounds.collect.play();
            GAME.save();
        }
    }
}

/**


CAUTION: LONGNESS AHEAD!!!!!!


**/


function spawnEntities(){
    if(GAME.difficulty == 0){
        if(GAME.level == 1){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 1 - Forest", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ A Melancholy Autumn ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 1000){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 2000){
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 500 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 3500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 4500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 650 == 200){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 5500){
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 7500){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 600 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 9000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 50 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 700 == 350){
                    entities.push(new Mirage(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 500 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
            }
            if(GAME.frameCount == 9000){
                entities.push(new DoomFairy(1199, 300, 0));
            }
        }else if(GAME.level == 2){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 2 - City", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Urban Groove ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount % 400 == 0){
                entities.push(new Wall(1199, 0, 200, 200, 1));
                entities.push(new Wall(1199,
                GAME.canvas.height - 200, 200, 200, 1));
            }
            if(GAME.frameCount < 500){
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
            }else if(GAME.frameCount < 1500){
                if(GAME.frameCount % 400 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 400 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 1));
                }
            }else if(GAME.frameCount < 5000){
                if(GAME.frameCount % 350 == 0){
                    if(GAME.frameCount % 250 >= 100){
                        entities.push(new DemonShape(1199, Math.random() * 550, 1));
                    }else{
                        entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 1));
                    }
                }
                if(GAME.frameCount % 250 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
            }else if(GAME.frameCount < 5250){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new Memory(1199, 280, 1));
                }
            }else if(GAME.frameCount < 6500){
                if(GAME.frameCount % 350 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
                if(GAME.frameCount % 400 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 1));
                }
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Memory(1199, 280, 1));
                }
            }else if(GAME.frameCount < 8000 && GAME.frameCount > 7000){
                if(GAME.frameCount % 800 == 0 && GAME.frameCount % 400 < 100){
                    entities.push(new WhiteHead(1199, 200 + Math.random() * 150, 1));
                    entities.push(new BlackHead(1199, 200 + Math.random() * 150, 1));
                }
            }else if(GAME.frameCount < 9750 && GAME.frameCount > 8000){
                if(GAME.frameCount % 300 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
                if(GAME.frameCount % 700 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 1));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Memory(1199, 280, 1));
                }
                if(GAME.frameCount % 2000 == 1000){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new WhiteHead(1199, Math.random() * 550, 1));
                        entities.push(new BlackHead(1199, Math.random() * 550, 1));
                    }else{
                        entities.push(new WhiteHead(1199, 200 + Math.random() * 150, 1));
                        entities.push(new BlackHead(1199, 200 + Math.random() * 150, 1));
                    }
                }
            }
            if(GAME.frameCount == 10000){
                entities.push(new Blazer(1199, 260, 1));
            }
        }else if(GAME.level == 3){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 3 - Mountain", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Bath of Ice ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 1000){
                if(GAME.frameCount % 250 == 0){
//nuclear pancreas
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 1600){
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 3000){
                if(GAME.frameCount % 400 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 4000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 5250){
                if(GAME.frameCount % 500 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 600 == 300){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 725 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 1000 == 400){
                    entities.push(new DemonShape(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 6000 && GAME.frameCount > 5500){
                if(GAME.frameCount % 500 == 250){
                    entities.push(new Canid(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 8000 && GAME.frameCount > 6250){
                if(GAME.frameCount % 400 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Canid(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 725 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 9700 && GAME.frameCount > 8000){
                if(GAME.frameCount % 700 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Canid(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 850 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 900 == 400){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 1));
                }
            }
            if(GAME.frameCount == 10000){
                entities.push(new Hostile(1159, Math.random() * 550, 1));
            }
        }else if(GAME.level == 4){
            //dead pianist
            //check for remaining enemies
            var hasWalls = false;
            var remaining = false;
            //check for reflector walls
            for(var i in entities){
                if(entities[i] instanceof Wall){
                    hasWalls = true;
                }else if(entities[i] instanceof Enemy){
                    remaining = true;
                }
            }
            if(!hasWalls){
                entities.push(new Wall(-20, -20, 40, GAME.canvas.height + 40, 2, 0, 0));
                entities.push(new Wall(-20, -20, GAME.canvas.width + 40, 40, 2, 0, 0));
                entities.push(new Wall(-20, GAME.canvas.height - 20, GAME.canvas.width + 20, 40, 2, 0, 0));
            }
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Final Stage - Lab", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Apocalypse Lab ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 1000){
                if(GAME.frameCount % 300 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 2000){
                if(GAME.frameCount % 75 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 1000 == 250){
                    entities.push(new Mirage(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 4000 && GAME.frameCount > 2500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 400 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 5000){
                if(GAME.frameCount % 400 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 1000 == 700){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 6500){
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 400 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 8000){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 250 == 125){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 9000 && GAME.frameCount > 8250){
                if(GAME.frameCount % 150 == 0){
                    entities.push(new Memory(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 500 == 300){
                    entities.push(new Mirage(800, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 10000 && GAME.frameCount > 9000){
                if(GAME.frameCount % 400 == 0){
                    entities.push(new Memory(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 400 == 125){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 12000 && GAME.frameCount > 10000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 600 == 300){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 1));
                }
            }
            if(GAME.frameCount > 12000 && !remaining){
                entities.push(new PatientZero(1199, Math.random() * 550, 1));
            }
        }
    }else if(GAME.difficulty == 1){
        if(GAME.level == 1){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 1 - Forest (Hard)", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ A Melancholy Autumn ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 500){
                if(GAME.frameCount % 50 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 1000){
                if(GAME.frameCount % 50 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 2000){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 3500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 4500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 650 == 200){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 5500){
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 50 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 7500){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 9000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 700 == 350){
                    entities.push(new Mirage(1199, Math.random() * 550, 1));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }
            if(GAME.frameCount == 9000){
                entities.push(new DoomFairy(1199, 300, 1));
            }
        }else if(GAME.level == 2){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 2 - City (Hard)", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Urban Groove ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount % 400 == 0){
                entities.push(new Wall(1199, 0, 200, 200, 1));
                entities.push(new Wall(1199,
                GAME.canvas.height - 200, 200, 200, 1));
            }
            if(GAME.frameCount < 500){
                if(GAME.frameCount % 100 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
            }else if(GAME.frameCount < 1500){
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 2));
                }
            }else if(GAME.frameCount < 5000){
                if(GAME.frameCount % 350 == 0){
                    if(GAME.frameCount % 250 >= 100){
                        entities.push(new DemonShape(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 2));
                    }
                }
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
            }else if(GAME.frameCount < 5250){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new Memory(1199, 280, 1));
                }
            }else if(GAME.frameCount < 6500){
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 2));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 2));
                    }
                }
                if(GAME.frameCount % 400 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 2));
                }
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Memory(1199, 280, 1));
                }
            }else if(GAME.frameCount < 8000 && GAME.frameCount > 7000){
                if(GAME.frameCount % 400 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new WhiteHead(1199, Math.random() * 550, 1));
                        entities.push(new BlackHead(1199, Math.random() * 550, 1));
                    }else{
                        entities.push(new WhiteHead(1199, 200 + Math.random() * 150, 1));
                        entities.push(new BlackHead(1199, 200 + Math.random() * 150, 1));
                    }
                }
            }else if(GAME.frameCount < 10000){
                if(GAME.frameCount % 300 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
                if(GAME.frameCount % 550 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 2));
                }
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Memory(1199, 280, 1));
                }
                if(GAME.frameCount % 600 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new WhiteHead(1199, Math.random() * 550, 1));
                        entities.push(new BlackHead(1199, Math.random() * 550, 1));
                    }else{
                        entities.push(new WhiteHead(1199, 200 + Math.random() * 150, 1));
                        entities.push(new BlackHead(1199, 200 + Math.random() * 150, 1));
                    }
                }
            }
            if(GAME.frameCount == 10000){
                entities.push(new Blazer(1199, 260, 2));
            }
        }else if(GAME.level == 3){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 3 - Mountain (Hard)", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Bath of Ice ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 1000){
                if(GAME.frameCount % 250 == 0){
//two nuclear pancreas
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 1600){
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 3000){
                if(GAME.frameCount % 400 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 4000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 5250){
                if(GAME.frameCount % 500 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 600 == 300){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 725 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 1000 == 400){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 6000 && GAME.frameCount > 5500){
                if(GAME.frameCount % 500 == 250){
                    entities.push(new Canid(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 8000 && GAME.frameCount > 6250){
                if(GAME.frameCount % 400 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Canid(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 725 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 9700 && GAME.frameCount > 8000){
                if(GAME.frameCount % 700 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Canid(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 850 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 900 == 400){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 3));
                }
            }
            if(GAME.frameCount == 10000){
                entities.push(new Hostile(1159, Math.random() * 550, 2));
            }
        }else if(GAME.level == 4){
            //dead pianist
            //check for remaining enemies
            var hasWalls = false;
            var remaining = false;
            //check for reflector walls
            for(var i in entities){
                if(entities[i] instanceof Wall){
                    hasWalls = true;
                }else if(entities[i] instanceof Enemy){
                    remaining = true;
                }
            }
            if(!hasWalls){
                entities.push(new Wall(-20, -20, 40, GAME.canvas.height + 40, 2, 0, 0));
                entities.push(new Wall(-20, -20, GAME.canvas.width + 40, 40, 2, 0, 0));
                entities.push(new Wall(-20, GAME.canvas.height - 20, GAME.canvas.width + 20, 40, 2, 0, 0));
            }
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Final Stage - Lab (Hard)", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Apocalypse Lab ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 1000){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 2000){
                if(GAME.frameCount % 50 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 1000 == 250){
                    entities.push(new Mirage(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 4000 && GAME.frameCount > 2500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 250 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 5000){
                if(GAME.frameCount % 300 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 800 == 700){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 6500){
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 8000){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 150 == 125){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 9000 && GAME.frameCount > 8250){
                if(GAME.frameCount % 150 == 0){
                    entities.push(new Memory(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 301 == 300){
                    entities.push(new Mirage(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 10000 && GAME.frameCount > 9000){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new Memory(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 400 == 125){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 12000 && GAME.frameCount > 10000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 300 == 299){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 450 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 3));
                }
            }
            if(GAME.frameCount > 12000 && !remaining){
                entities.push(new PatientZero(1199, Math.random() * 550, 2));
            }
        }
    }else{
        if(GAME.level == 1){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 1 EX - Dark Forest", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ [something something something] ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 500){
                if(GAME.frameCount % 25 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 2));
                }
            }else if(GAME.frameCount < 1000){
                if(GAME.frameCount % 50 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 2000){
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 3500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 750 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 4500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 650 == 200){
                    entities.push(new Raven(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 5500){
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 7500){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 9000){
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Raven(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 200 == 0){
                    entities.push(new Bat(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Lost(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 700 == 350){
                    entities.push(new Mirage(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 400 == 200){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }
            if(GAME.frameCount == 9000){
                entities.push(new DoomFairy(1199, 300, 3));
            }
        }else if(GAME.level == 2){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 2 EX - The Plague Nest", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ [something something] ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount % 400 == 0){
                entities.push(new Wall(1199, 0, 200, 200, 1));
                entities.push(new Wall(1199,
                GAME.canvas.height - 200, 200, 200, 1));
            }
            if(GAME.frameCount < 500){
                if(GAME.frameCount % 50 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }else if(GAME.frameCount < 1500){
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }else if(GAME.frameCount < 2500){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 3));
                }
            }else if(GAME.frameCount < 5000){
                if(GAME.frameCount % 350 == 0){
                    if(GAME.frameCount % 250 >= 100){
                        entities.push(new DemonShape(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 3));
                    }
                }
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }else if(GAME.frameCount < 5250){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new Memory(1199, 280, 3));
                }
            }else if(GAME.frameCount < 6500){
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
                if(GAME.frameCount % 400 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 3));
                }
                if(GAME.frameCount % 500 == 0){
                    entities.push(new Memory(1199, 280, 3));
                }
            }else if(GAME.frameCount < 8000 && GAME.frameCount > 7000){
                if(GAME.frameCount % 200 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new WhiteHead(1199, Math.random() * 550, 3));
                        entities.push(new BlackHead(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new WhiteHead(1199, 200 + Math.random() * 150, 3));
                        entities.push(new BlackHead(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }else if(GAME.frameCount < 10000){
                if(GAME.frameCount % 300 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new Lost(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new Lost(1199, 200 + Math.random() * 150, 3));
                    }
                }
                if(GAME.frameCount % 550 == 0){
                    entities.push(new DemonShape(1199, 200 + Math.random() * (200 - 65), 3));
                }
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Memory(1199, 280, 3));
                }
                if(GAME.frameCount % 400 == 0){
                    if(GAME.frameCount % 400 >= 100){
                        entities.push(new WhiteHead(1199, Math.random() * 550, 3));
                        entities.push(new BlackHead(1199, Math.random() * 550, 3));
                    }else{
                        entities.push(new WhiteHead(1199, 200 + Math.random() * 150, 3));
                        entities.push(new BlackHead(1199, 200 + Math.random() * 150, 3));
                    }
                }
            }
            if(GAME.frameCount == 10000){
                entities.push(new Blazer(1199, 260, 3));
            }
        }else if(GAME.level == 3){
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 3 EX - Peak of Pain", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ Bath of Ice ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 1000){
                if(GAME.frameCount % 250 == 0){
//nuclear pancreas
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 1600){
                if(GAME.frameCount % 300 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 3000){
                if(GAME.frameCount % 250 == 0){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 800 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Blower(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 4000){
                if(GAME.frameCount % 300 == 0){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 5250){
                if(GAME.frameCount % 500 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 600 == 300){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 725 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 1000 == 400){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 6000 && GAME.frameCount > 5500){
                if(GAME.frameCount % 250 == 1){
                    entities.push(new Canid(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 8000 && GAME.frameCount > 6250){
                if(GAME.frameCount % 300 == 1){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 600 == 0){
                    entities.push(new Canid(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 725 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 1000 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
            }else if(GAME.frameCount < 9700 && GAME.frameCount > 8000){
                if(GAME.frameCount % 1100 == 250){
                    entities.push(new CrossShot(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 1100 == 0){
                    entities.push(new Canid(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 1100 == 700){
                    entities.push(new Blower(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 250 == 0){
                    entities.push(new DemonShape(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 1100 == 400){
                    entities.push(new HeadSplitter(1199, Math.random() * 550, 1));
                }
            }
            if(GAME.frameCount == 10000){
                entities.push(new Hostile(1159, Math.random() * 550, 3));
            }
        }else if(GAME.level == 4){
            var hasWalls = false;
            var remaining = false;
            //check for reflector walls
            for(var i in entities){
                if(entities[i] instanceof Wall){
                    hasWalls = true;
                }else if(entities[i] instanceof Enemy){
                    remaining = true;
                }
            }
            if(!hasWalls){
                entities.push(new Wall(-20, -20, 40, GAME.canvas.height + 40, 2, 0, 0));
                entities.push(new Wall(-20, -20, GAME.canvas.width + 40, 40, 2, 0, 0));
                entities.push(new Wall(-20, GAME.canvas.height - 20, GAME.canvas.width + 20, 40, 2, 0, 0));
            }
            if(GAME.frameCount == 0){
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2,
                                "Stage 4 EX - Secret Lab", 50, [0, 0, 0], 150));
                entities.push(new Text(GAME.canvas.width/2, GAME.canvas.height/2 + 50,
                                "BGM: ♪ [something] ♪", 20, [100, 100, 100], 150));
            }
            if(GAME.frameCount < 750){
                if(GAME.frameCount % 350 == 0){
                    entities.push(new Soulja(1199, Math.random() * 550));
                }
            }else if(GAME.frameCount < 1500){
                if(GAME.frameCount % 75 == 0){
                    entities.push(new Genex(1199, Math.random() * 550));
                }
            }else if(GAME.frameCount < 3500){
                if(GAME.frameCount % 350 == 0){
                    entities.push(new Gong(1199, Math.random() * 550));
                }
                if(GAME.frameCount % 11 == 0 && GAME.frameCount > 3000){
                    entities.push(new Bat(1199, Math.random() * 550, 2));
                }
                if(GAME.frameCount % 11 == 6 && GAME.frameCount > 3000){
                    entities.push(new Bat(1199, Math.random() * 550, 1));
                }
            }else if(GAME.frameCount < 4500){
                if(GAME.frameCount % 100 == 0){
                    entities.push(new Genex(1199, Math.random() * 550, 3));
                }
                if(GAME.frameCount % 350 == 200){
                    entities.push(new Gong(1199, Math.random() * 550));
                }
            }
        }
    }
}

/**


LONGNESS OVER


**/

function drawMenu(){
    if(GAME.level == 0){
        for(var i in menuEntities){
            menuEntities[i].update();
            menuEntities[i].draw();
            menuEntities[i].interact(player);
            if(menuEntities[i].dead){
                menuEntities.splice(i, 1);
                i--;
            }
        }
    }
}
function main(){
    if(!GAME.loadedEverything){
        for(var i in spriteAnimations){
            for(var j in spriteAnimations[i].spriteList){
                if(!spriteAnimations[i].spriteList[j].image){
                    console.log("Still loading!");
                    setSprites();
                    return;
                }
            }
        }
        GAME.loadedEverything = true;
        return;
    }
    GAME.clear();
    GAME.context.fillStyle = "#FFFFFF";
    if(GAME.level == 3){
        GAME.context.fillStyle = "#BBBBBB";
    }
    GAME.context.fillRect(-GAME.canvas.width * 3, -GAME.canvas.height * 3,
    GAME.canvas.width * 6, GAME.canvas.height * 6);
    spawnBackground();
    drawBackground();
    player.update();
    if(GAME.level == 3){
        player.applyForce(-0.2, 0);
    }
    for(var i in entities){
        if(entities[i] instanceof Entity){
            entities[i].update();
            entities[i].draw();
            entities[i].interact(player);
            if(GAME.level == 3){
                entities[i].applyForce(-0.2, 0);
            }
            if(entities[i] instanceof Bullet ||
            entities[i] instanceof Wall){
                for(var j in entities){
                    entities[i].interact(entities[j]);
                }
            }
            if(entities[i].dead){
                entities.splice(i, 1);
                i--;
            }
        }
    }
    drawMenu();
    drawForeground();
    spawnEntities();
    handleCheckpoints();
    GAME.frameCount++;
}
//footer
        </script>
    </head>
    <body onload="init()">
        <div id="output"></div>
        <img id="player" class="img" src="./images/Son.png" alt="It didn't work.">
        <img id="lost" class="img" src="./images/Lost.png" alt="It didn't work.">
        <img id="lost2" class="img" src="./images/Lost-Walk2.png" alt="It didn't work.">
        <img id="lost3" class="img" src="./images/Lost-Walk3.png" alt="It didn't work.">
        <img id="lost4" class="img" src="./images/Lost-Walk4.png" alt="It didn't work.">
        <img id="lost5" class="img" src="./images/Lost-Walk5.png" alt="It didn't work.">
        <img id="lost6" class="img" src="./images/Lost-Walk6.png" alt="It didn't work.">
        <img id="lost7" class="img" src="./images/Lost-Walk7.png" alt="It didn't work.">
        <img id="lost8" class="img" src="./images/Lost-Walk8.png" alt="It didn't work.">
        <img id="cross" class="img" src="./images/Cross.png" alt="It didn't work.">
        <img id="cross-tilt" class="img" src="./images/Cross2.png" alt="It didn't work.">
        <img id="bat" class="img" src="./images/Bat.png" alt="It didn't work.">
        <img id="bat-fl-up" class="img" src="./images/Bat-FlapUp.png" alt="It didn't work.">
        <img id="bat-fl-down" class="img" src="./images/Bat-FlapDown.png" alt="It didn't work.">
        <img id="raven" class="img" src="./images/Raven.png" alt="It didn't work.">
        <img id="raven2" class="img" src="./images/Raven2.png" alt="It didn't work.">
        <img id="raven3" class="img" src="./images/Raven3.png" alt="It didn't work.">
        <img id="raven4" class="img" src="./images/Raven4.png" alt="It didn't work.">
        <img id="raven5" class="img" src="./images/Raven5.png" alt="It didn't work.">
        <img id="raven6" class="img" src="./images/Raven6.png" alt="It didn't work.">
        <img id="raven7" class="img" src="./images/Raven7.png" alt="It didn't work.">
        <img id="raven8" class="img" src="./images/Raven8.png" alt="It didn't work.">
        <img id="raven9" class="img" src="./images/Raven9.png" alt="It didn't work.">
        <img id="mirage" class="img" src="./images/Mirage.png" alt="It didn't work.">
        <img id="demon" class="img" src="./images/DemonicShape.png" alt="It didn't work.">
        <img id="memory" class="img" src="./images/Memory.png" alt="It didn't work.">
        <img id="memory-tr1" class="img" src="./images/Memory-Triggered1.png" alt="It didn't work.">
        <img id="memory-tr2" class="img" src="./images/Memory-Triggered2.png" alt="It didn't work.">
        <img id="blackhead" class="img" src="./images/Blackhead.png" alt="It didn't work.">
        <img id="blackhead2" class="img" src="./images/Blackhead2.png" alt="It didn't work.">
        <img id="whitehead" class="img" src="./images/Whitehead.png" alt="It didn't work.">
        <img id="whitehead-laser" class="img" src="./images/Whitehead-Laser.png" alt="It didn't work.">
        <img id="blower" class="img" src="./images/Blower.png" alt="It didn't work.">
        <img id="headsplitter" class="img" src="./images/HeadSplitter.png" alt="It didn't work.">
        <img id="canid" class="img" src="./images/Canid.png" alt="It didn't work.">
        <img id="canid-hurt" class="img" src="./images/Canid-Hurt.png" alt="It didn't work.">
        <img id="snow" class="img" src="./images/Snow.png" alt="It didn't work.">
        <img id="forest-guard-neutral" class="img" src="./images/ForestBoss-Neutral.png" alt="It didn't work.">
        <img id="forest-guard-neutral2" class="img" src="./images/ForestBoss-Neutral2.png" alt="It didn't work.">
        <img id="forest-guard-neutral3" class="img" src="./images/ForestBoss-Neutral3.png" alt="It didn't work.">
        <img id="forest-guard-neutral4" class="img" src="./images/ForestBoss-Neutral4.png" alt="It didn't work.">
        <img id="forest-guard-roar1" class="img" src="./images/ForestBoss-Roar1.png" alt="It didn't work.">
        <img id="forest-guard-roar2" class="img" src="./images/ForestBoss-Roar2.png" alt="It didn't work.">
        <img id="forest-guard-roar3" class="img" src="./images/ForestBoss-Roar3.png" alt="It didn't work.">
        <img id="forest-guard-roar4" class="img" src="./images/ForestBoss-Roar4.png" alt="It didn't work.">
        <img id="lonely-blink2" class="img" src="./images/CityBoss-Blink2.png" alt="It didn't work.">
        <img id="lonely-blink3" class="img" src="./images/CityBoss-Blink3.png" alt="It didn't work.">
        <img id="lonely-neutral" class="img" src="./images/CityBoss-Neutral.png" alt="It didn't work.">
        <img id="lonely-neutral2" class="img" src="./images/CityBoss-Neutral2.png" alt="It didn't work.">
        <img id="lonely-neutral3" class="img" src="./images/CityBoss-Neutral3.png" alt="It didn't work.">
        <img id="lonely-neutral4" class="img" src="./images/CityBoss-Neutral4.png" alt="It didn't work.">
        <img id="lonely-neutral5" class="img" src="./images/CityBoss-Neutral5.png" alt="It didn't work.">
        <img id="lonely-neutral6" class="img" src="./images/CityBoss-Neutral6.png" alt="It didn't work.">
        <img id="hostile" class="img" src="./images/Hate.png" alt="It didn't work.">
        <img id="zero1" class="img" src="./images/PatientZero-1.png" alt="It didn't work.">
        <img id="zero2" class="img" src="./images/PatientZero-2.png" alt="It didn't work.">
        <img id="zero3" class="img" src="./images/PatientZero-3.png" alt="It didn't work.">
        <img id="zero4" class="img" src="./images/PatientZero-4.png" alt="It didn't work.">
        <img id="zero5" class="img" src="./images/PatientZero-5.png" alt="It didn't work.">
        <img id="zero6" class="img" src="./images/PatientZero-6.png" alt="It didn't work.">
        <img id="zero7" class="img" src="./images/PatientZero-7.png" alt="It didn't work.">
        <img id="zero8" class="img" src="./images/PatientZero-8.png" alt="It didn't work.">
        <img id="zero9" class="img" src="./images/PatientZero-9.png" alt="It didn't work.">
        <img id="zero10" class="img" src="./images/PatientZero-10.png" alt="It didn't work.">
        <img id="zero11" class="img" src="./images/PatientZero-11.png" alt="It didn't work.">
        <img id="zero12" class="img" src="./images/PatientZero-12.png" alt="It didn't work.">
        <img id="wall" class="img" src="./images/Wall.png" alt="It didn't work.">
        <img id="reflector1" class="img" src="./images/Reflector1.png" alt="It didn't work.">
        <img id="reflector2" class="img" src="./images/Reflector2.png" alt="It didn't work.">
        <img id="reflector3" class="img" src="./images/Reflector3.png" alt="It didn't work.">
        <img id="reflector4" class="img" src="./images/Reflector4.png" alt="It didn't work.">
        <img id="forestBG" class="img" src="./images/ForestBG.png" alt="It didn't work.">
        <img id="cityBG" class="img" src="./images/CityBG.png" alt="It didn't work.">
        <img id="mountainBG" class="img" src="./images/MountainBG.png" alt="It didn't work.">
        <img id="labBG" class="img" src="./images/LabBG.png" alt="It didn't work.">
    </body>
</html>